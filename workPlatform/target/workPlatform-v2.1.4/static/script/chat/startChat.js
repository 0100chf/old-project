define(["jquery","jqueryUI","layer"],function(c){var b="00300";var a={init:function(h,j,i,g,f){var e=this;var d=e.checkChatWindowStatus(h,i);switch(d){case"000":case"110":e.openChatWindow(h,j,i,g,f);break;case"100":c("div#zhcs_OA_chatWindow").show();e.openChatWindow(h,j,i,g,f);break;case"101":c("div#zhcs_OA_chatWindow").show();e.activatesCurrentDialog("",h,i,f);break;case"111":e.activatesCurrentDialog("",h,i,f);break}},activatesCurrentDialog:function(g,k,i,e){var d=c("div#zhcs_OA_chatWindow");var f=d.find("#zhcs_OA_chatWindowLeft");var h=d.find("#zhcs_OA_chatWindowContent");var j=d.find("#zhcs_OA_chatWindowRight");var l=f.find("#chatWindow_left"+i+g+k);if(l.hasClass("current")){}else{this.refreshChatWindowTop(d,{type:i,name:e,targetId:k});l.addClass("current").siblings().removeClass("current");if(i=="1"){j.show().find("#chatWindow_right"+i+g+k).show().siblings().hide();h.find("#chatWindow_content"+i+k).show().siblings().hide()}else{j.hide();h.find("#chatWindow_content"+i+g+this.mergeId(k,loginUserInfo.userId)).show().siblings().hide()}}},mergeId:function(e,d){if(e>d){return""+e+d}else{return""+d+e}},checkChatWindowStatus:function(e,f){var g=c("div#zhcs_OA_chatWindow");var d;if(g.length>0){if(g.is(":hidden")){if(g.find("#zhcs_OA_chatWindowLeft").find("#chatWindow_left"+f+e).length>0){d="101"}else{d="100"}}else{if(g.find("#zhcs_OA_chatWindowLeft").find("#chatWindow_left"+f+e).length>0){d="111"}else{d="110"}}}else{d="000"}return d},getUserInfo:function(f){var e={logo:"",name:""};var d=window.projectUserList[f];if(f>0){if(d){e.logo=d.logo;e.name=d.name}}return e},createChatWindowRight:function(h,g,e){var d=this;var f="";f+="<div class='chatGroup' id='chatWindow_right1"+e+"' data-groupId='"+e+"'>";f+="<ul class='friends_list'>";if(g==b){c.each(window.projectUserList,function(i,j){f+="<li class='friends-item' data-id='"+i+"'>";f+="<a class='img'><img src='"+j.logo+"' class='img-circle'></a>";f+="<a class='item-title'>"+j.name+"</a>";f+="<span class='badge'></span></li>"})}else{c.each(h,function(j,k){var i=d.getUserInfo(k);f+="<li class='friends-item' data-id='"+k+"'>";f+="<a class='img'><img src='"+i.logo+"' class='img-circle'></a>";f+="<a class='item-title'>"+i.name+"</a>";f+="<span class='badge'></span></li>"})}f+="</ul></div>";return f},loadChatWindowRight:function(i,h,g,f,d){var e=i.find("#zhcs_OA_chatWindowRight");if(f=="0"){e.hide()}else{e.show().find("div.chatGroup").hide();e.append(this.createChatWindowRight(h,g,d))}},createChatWindowContent:function(e,h,f,d){var g="";if(e=="0"){g+="<ul id='chatWindow_content"+e+d+this.mergeId(h,loginUserInfo.userId)+"'"}else{g+="<ul id='chatWindow_content"+e+h+"'"}if(f){g+=" style='display:none;'>"}else{g+=">"}g+="<li class='more-message'><a><i class=' icon-clock-1'></i>查看更多消息</a></li>";g+="</ul>";return g},loadChatWindowContent:function(i,f,j,h,e){var g=i.find("#zhcs_OA_chatWindowContent");var d=g.find("#chatWindow_content"+f+e+this.mergeId(j,loginUserInfo.userId));g.find("ul").hide();if(d.length>0){d.show()}else{g.append(this.createChatWindowContent(f,j,h,e))}},refreshChatWindowTop:function(g,e){var f=g.find("#zhcs_OA_chatWindowTop");f.data("type",e.type);f.data("id",e.targetId);if(e.type=="1"){f.find("div.titles img").hide()}else{f.find("div.titles img").show().attr("src",this.getUserInfo(e.targetId).logo)}var d=f.find("div.titles span");d.text(e.name.length<=30?e.name:e.name.substr(0,30)+"...");d.prop("title",e.name)},createChatWindowLeft:function(j,g,e,f){var d=this;var h=d.getUserInfo(j).logo;var i="";if(g=="0"){i+="<li class='friends-item current' id='chatWindow_left"+g+f+j+"' data-id='"+j+"'  data-type='"+g+"'>";i+="<a class='img'><img src='"+h+"' class='img-circle'></a>"}else{i+="<li class='friends-item current' id='chatWindow_left"+g+j+j+"' data-id='"+j+"' data-type='"+g+"'>";i+="<a class='img'><img src='' class='img-circle' style='display:none'></a>"}i+="<a class='item-title'>"+e+"</a>";i+="<i class=' icon-cancel-circled' title='关闭'  style='display:none'></i>";i+="<span class='badge'></span>";i+="</li>";return i},loadChatWindowLeft:function(h,i,f,d,e){var g=h.find("#zhcs_OA_chatWindowLeft");g.find("ul li").removeClass("current");g.find("ul").append(this.createChatWindowLeft(i,f,d,e));if(g.find("ul li").length>1){g.show()}else{g.hide()}},loadChatWindow:function(h,f,g,j,e,k){var l=this;var d=c("div#zhcs_OA_chatWindow");if(d.length>0){l.refreshChatWindowTop(d,{type:j,name:e,targetId:k});l.loadChatWindowLeft(d,k,j,e,h);l.loadChatWindowContent(d,j,k,null,h);l.loadChatWindowRight(d,f,g,j,k)}else{var i=c("<div></div>");i.load(context+"/task/loadChat.htm",function(){l.refreshChatWindowTop(i,{type:j,name:e,targetId:k});l.loadChatWindowLeft(i,k,j,e,h);l.loadChatWindowContent(i,j,k,null,h);l.loadChatWindowRight(i,f,g,j,k);c(document.body).append(i.html());var m=c("#zhcs_OA_chatWindowTop");m.on("click","a.icon-cancel",function(){c(this).closest("div#zhcs_OA_chatWindow").remove();return false});m.data("groupId",k);m.data("type",j);m.data("id",k)})}},openChatWindow:function(g,i,h,f,e){var d=this;if(i==b){d.loadChatWindow("",null,i,h,e,g)}else{c.ajax({type:"post",data:{taskId:g},url:context+"/task/findTaskUser.htm"}).done(function(k){if(k.resultData&&k.success){var l=k.resultData;var j=false;c.each(l,function(n,m){if(m==loginUserInfo.userId){j=true;return false}});if(j){d.loadChatWindow("",l,i,h,e,g)}else{layer.msg("不属于聊天人员")}}else{layer.msg("请求失败")}}).fail(function(){layer.msg("请求失败")})}},createChatMessageHtml:function(e,g,h,f,d){var i="";if(g){i+="<li class='last right'>";i+="<p class='time'>"+new Date(h).format("yyyy-MM-dd hh:mm:ss")+"</p>"}else{i+="<li class='last left'>";i+="<p class='time'><a>"+this.getUserInfo(d).name+"&nbsp;</a>"+new Date(h).format("yyyy-MM-dd hh:mm:ss")+"</p>"}if(e==0){i+="<div class='post-content text'>";i+="<p>"+f.replace(/\[em_([1-9]|[1][0-6])\]/gi,'<img src="'+context+'/static/images/expression/$1.gif" border="0" />')+"</p>"}else{if(e==1){i+="<div class='post-content picture'>";i+="<img src='"+f+"'>"}else{i+="<div class='post-content file'>";i+=f}}i+="</div></li>";return i},fileSizeUnit:function(d){if(d>=1024*1024){d=(Math.round(d*100/(1024*1024))/100).toString()+"MB"}else{d=(Math.round(d*100/1024)/100).toString()+"KB"}return d}};return a});