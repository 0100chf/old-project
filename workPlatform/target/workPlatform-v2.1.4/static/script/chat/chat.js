require(["jquery","script/chat/startChat","script/chat/chatExpression","script/chat/chatSocket","script/common/dialogAlert"],function(d,f,a,b,e){var c={init:function(){this.chatWindow=d("#zhcs_OA_chatWindow");this.chatWindowTop=d("#zhcs_OA_chatWindowTop",this.chatWindow);this.chatWindowMin=d(".chat_mini",this.chatWindow);this.chatWindowLeft=d("#zhcs_OA_chatWindowLeft",this.chatWindow);this.chatWindowCenter=d("#zhcs_OA_chatWindowCenter",this.chatWindow);this.chatWindowContent=d("#zhcs_OA_chatWindowContent",this.chatWindow);this.chatWindowSendMessage=d("#zhcs_OA_chatWindowSendMessage",this.chatWindow);this.chatTextarea=this.chatWindowCenter.find("textarea");this.chatWindowExpression=this.chatWindowCenter.find("#zhcs_OA_chatWindowExpression");this.chatWindowRight=d("#zhcs_OA_chatWindowRight",this.chatWindow);a.init({tab:this.chatWindowExpression,ele:this.chatTextarea});this.setEvent();var h=this.chatWindowTop.data("id");var g=this.chatWindowTop.find(".titles span").text();b.init(h,g)},setEvent:function(){this.moveChatWindow();this.closeChatWindow();this.minChatWindow();this.leftSwitchDialog();this.rightSwitchDialog();this.removeSingleChatWindow();this.openExpression();this.sendMessage();this.sendPicture();this.sendFile();this.closeCurrentWindowBtn();this.chatHistoryMessage()},leftSwitchDialog:function(){var g=this;this.chatWindowLeft.on("click","ul.friends_list li",function(){var k=d(this).data("id");var j=d(this).data("type");var h=d(this).text();var i=j=="0"?g.chatWindowTop.data("groupId"):k;f.activatesCurrentDialog(i,k,j,h);d(this).find("span.badge").text("")});this.chatWindowLeft.on("mouseover","ul.friends_list li",function(){d(this).find("i.icon-cancel-circled").show()});this.chatWindowLeft.on("mouseout","ul.friends_list li",function(){d(this).find("i.icon-cancel-circled").hide()})},rightSwitchDialog:function(){var g=this;this.chatWindowRight.on("click","li.friends-item",function(){var j=d(this).data("id");var h=d(this).text();var i=d(this).closest("div").attr("data-groupId");if(j==loginUserInfo.userId){}else{if(g.chatWindowLeft.find("#chatWindow_left0"+i+j).length>0){f.activatesCurrentDialog(i,j,"0",h)}else{f.loadChatWindow(i,null,null,"0",h,j)}d(this).find("span.badge").text("")}})},openExpression:function(){var g=this;this.chatWindowCenter.on("click","a.icon-emo-grin",function(){g.chatWindowExpression.removeClass("g-hide");return false})},fileProgress:function(i,g){g=f.fileSizeUnit(g);var h="<div><p>"+i+"<a>("+g+")</a></p></div>";h+="<div class='progress-chat'>";h+="<a class='progress-chat-val'>0%</a>";h+="<a class='progress-chat-bar'><em class='progress-chat-in' style='width: 0%'></em> </a></div>";h+="<a class='word-cancel'>取消</a>";return h},sendFileError:function(h,g){h.find("div.progress-chat,a.word-cancel").remove();h.find("div.post-content").append("<p style='color:red;'>"+g+"</p>")},downloadFile:function(l,i){var h=document.createElement("a"),g=document.createEvent("HTMLEvents"),j=i.slice(0,5)==="data:",k=i.lastIndexOf(".")>-1;if(/firefox/.test(navigator.userAgent.toLowerCase())){g=document.createEvent("MouseEvents")}g.initEvent("click",false,false);h.download=l;h.href=k||j?i:URL.createObjectURL(new Blob([i]));h.dispatchEvent(g)},clearInputFile:function(g){d(g).after(g.clone(true).val(""));d(g).remove()},sendFile:function(){var g=this;this.chatWindowCenter.on("click","button.btn-success",function(j){var i=d(this).data("name");var h=d(this).data("url");g.downloadFile(i,context+"/static/uploadfile/"+h);return false});this.chatWindowCenter.on("click","a#select_file",function(h){g.chatWindowCenter.find("form#send_file input").click();return false});this.chatWindowCenter.find("form#send_file").on("change","input",function(h){var j=d(this);if(!b.getConnectionIo()||b.getConnectionIo().disconnected){g.clearInputFile(j);e.alert("聊天异常！");return false}var l=this.files[0];if(l){var m=l.size;var n=l.name;if(m>10*1024*1024){g.clearInputFile(j);e.alert("文件大小不能大于10MB！");return false}var k=new FormData();k.append("chatFile",l);var q=g.chatWindowTop.data("type");var o="";var p="";var i=g.chatWindowTop.data("id");var r;if(q=="0"){p=i;o=g.chatWindowTop.data("groupId");r=g.chatWindowContent.find("ul#chatWindow_content"+q+o+f.mergeId(i,loginUserInfo.userId))}else{r=g.chatWindowContent.find("ul#chatWindow_content"+q+i)}var s=new XMLHttpRequest();s.withCredentials=true;s.open("POST",context+"/task/chatUploadFile.htm",true);s.onloadstart=function(){g.chatFileProgress=d(f.createChatMessageHtml(2,true,new Date(),g.fileProgress(n,m),loginUserInfo.userId)).appendTo(r);r.animate({scrollTop:r[0].scrollHeight},300);g.chatFileProgress.find("a.word-cancel").on("click",function(){s.abort();g.sendFileError(g.chatFileProgress,"文件上传被取消")})};s.onload=function(){var v=d.parseJSON(this.response);if(this.status==200){var t=v.resultData.filePath;b.sendMessage({toUser:p,content:"",recordType:"2",fileUrl:t,fileSize:m,fileName:n});g.chatFileProgress.find("a.word-cancel").remove();var u=d("<button class='btn btn-xs btn-success'>下载</button>");u.data("url",t);u.data("name",n);g.chatFileProgress.find(".progress-chat").replaceWith(u)}else{g.sendFileError(g.chatFileProgress,"文件上传失败")}g.clearInputFile(j)};s.onerror=function(t){g.clearInputFile(j);g.sendFileError(g.chatFileProgress,"文件上传异常")};s.upload.onprogress=function(u){var t=0;if(u.lengthComputable){t=Math.round(u.loaded*100/u.total)+"%";g.chatFileProgress.find(".progress-chat-val").text(t);g.chatFileProgress.find(".progress-chat-in").css("width",t)}};s.send(k)}return false})},sendPicture:function(){var g=this;this.chatWindowCenter.on("click","a#select_picture",function(h){g.chatWindowCenter.find("form#send_picture input").click();return false});this.chatWindowCenter.find("form#send_picture").on("change","input",function(l){var j=d(this);if(!b.getConnectionIo()||b.getConnectionIo().disconnected){g.clearInputFile(j);e.alert("聊天异常！");return false}var k=this.files;if(k.length!=0){var i=k[0];var h=new FileReader();if(!h){e.alert("该浏览器不支持图片发送！");g.clearInputFile(j);return}var m=new RegExp(".+(.jpeg|.jpg|.gif|.bmp|.png)$","gi");if(!m.test(i.type)){e.alert("请选择正确格式的图片！");g.clearInputFile(j);return}if(i.size>1024*1024){g.clearInputFile(j);e.alert("图片不能大于1MB！");return}h.readAsDataURL(i);h.onload=function(s){var t=EventUtil.getTarget(s);var r=t.result;var p="";var o="";var u=g.chatWindowTop.data("id");var q=g.chatWindowTop.data("type");var n;if(q==0){o=u;p=g.chatWindowTop.data("groupId");n=g.chatWindowContent.find("ul#chatWindow_content"+q+p+f.mergeId(u,loginUserInfo.userId))}else{n=g.chatWindowContent.find("ul#chatWindow_content"+q+u)}n.append(f.createChatMessageHtml(1,true,new Date(),r,loginUserInfo.userId));n.animate({scrollTop:n[0].scrollHeight},300);b.sendMessage({toUser:o,content:r,recordType:"1"});g.clearInputFile(j)}}return false})},moveChatWindow:function(){this.chatWindow.draggable({handle:".chat_header",containment:"window",scroll:false})},removeSingleChatWindow:function(){var g=this;this.chatWindowLeft.on("click","li .icon-cancel-circled",function(){var p=d(this).closest("li");var i=p.hasClass("current");var h=p.data("id");var o=p.data("type");var l=o=="0"?g.chatWindowTop.data("groupId"):p.data("id");var m=p.siblings("li").length;p.remove();if(o=="0"){g.chatWindowContent.find("#chatWindow_content"+o+l+f.mergeId(h,loginUserInfo.userId)).remove()}else{g.chatWindowContent.find("#chatWindow_content"+o+h).remove()}g.chatWindowRight.find("#chatWindow_right"+o+l+h).remove();if(m>1){}else{g.chatWindowLeft.hide()}if(i){var q=g.chatWindowLeft.find("li:eq(0)");var j=q.data("id");var k=q.data("type");var n=q.text();f.activatesCurrentDialog(l,j,k,n)}return false})},closeChatWindow:function(){var g=this;this.chatWindowTop.on("off","a.icon-cancel");this.chatWindowTop.on("click","a.icon-cancel",function(){g.chatWindow.remove();b.disconnection();return false})},minChatWindow:function(){var g=this;this.chatWindowTop.on("click","a.icon-minus",function(){g.chatWindow.find(".chat_box").hide();g.chatWindowMin.show();g.updateChatNum();return false});this.chatWindowMin.on("click",function(){d(this).hide();g.chatWindow.find(".chat_box").show();return false})},closeCurrentWindowBtn:function(){var g=this;this.chatWindowSendMessage.on("click","#closeBtn",function(){var o=g.chatWindowLeft.find("li.current");var l=o.siblings("li").length;if(l>0){var h=g.chatWindowTop.data("id");var n=g.chatWindowTop.data("type");var k=n=="0"?g.chatWindowTop.data("groupId"):o.data("id");o.remove();if(n=="0"){g.chatWindowContent.find("#chatWindow_content"+n+k+f.mergeId(h,loginUserInfo.userId)).remove()}else{g.chatWindowContent.find("#chatWindow_content"+n+h).remove()}g.chatWindowRight.find("#chatWindow_right"+n+k+h).remove();if(l==1){g.chatWindowLeft.hide()}var p=g.chatWindowLeft.find("li:eq(0)");var i=p.data("id");var j=p.data("type");var m=p.text();f.activatesCurrentDialog(k,i,j,m)}else{b.disconnection();g.chatWindow.remove()}})},sendMessage:function(){var g=this;this.chatWindowSendMessage.on("click","#sendMessageBtn",function(){if(!b.getConnectionIo()||b.getConnectionIo().disconnected){e.alert("聊天异常！");return false}var k=g.chatWindowTop.data("type");var j="";var m=g.chatWindowTop.data("id");var l=g.chatTextarea.val();var i="";if(l==""){return false}var h;if(k=="0"){j=g.chatWindowTop.data("groupId");i=m;h=g.chatWindowContent.find("#chatWindow_content"+k+j+f.mergeId(m,loginUserInfo.userId))}else{h=g.chatWindowContent.find("#chatWindow_content"+k+m)}h.append(f.createChatMessageHtml(0,true,new Date(),l,loginUserInfo.userId));g.chatTextarea.val("");b.sendMessage({toUser:i,content:l,recordType:"0"});h.animate({scrollTop:h[0].scrollHeight},300);return false})},chatHistoryMessage:function(){var g=this;this.chatWindowCenter.on("click","li.more-message",function(){var h=d(this);var i=g.chatWindowTop.data("groupId");var j="";if(g.chatWindowTop.data("type")=="0"){j=g.chatWindowTop.data("id")}d.ajax({url:nodeJsUrl+"/getRecords",type:"get",data:{roomId:i,currentUserName:loginUserInfo.userId,friendUserName:j}}).done(function(k){if(k.records){h.siblings().remove();h.after(g.getChatHistoryContent(k.records)).hide()}}).fail(function(){})})},getChatHistoryContent:function(l){var n="";for(var h=l.length-1;h>=0;h--){var m=l[h];var k=m.fromUser==loginUserInfo.userId?true:false;var j="";if(m.recordType!="2"){j=m.content}else{var g=f.fileSizeUnit(m.fileSize);j="<div><p>"+m.fileName+"<a>("+g+")</a></p></div><button data-url='"+m.fileUrl+"' data-name='"+m.fileName+"' class='btn btn-xs btn-success'>下载</button>"}n+=f.createChatMessageHtml(m.recordType,k,m.fromTime,j,m.fromUser)}return n},updateChatNum:function(){var g=this.chatWindowLeft.find("li").length;this.chatWindowMin.find("span.num").text(g)}};c.init()});