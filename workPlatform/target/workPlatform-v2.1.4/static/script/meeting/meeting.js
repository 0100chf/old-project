require(["script/common/personList","script/meeting/addmeeting","jqueryForm","jquery","layer"],function(b,c){var a={init:function(){this.panel=$(".meeting_content");this.projectId=this.panel.closest("div[data-id='projectTemplate']").data("projectId");this.viewInit();this.setEvent()},viewInit:function(){var d=this;$.each(d.panel.find("textarea.hidden_overflow"),function(e,f){$(this).css("height",this.scrollHeight+"px")})},setEvent:function(){var e=this;var f="eventSelectUser",g=window.projectUserList;e.panel.on("click","ul li.add_user_li",function(){var h=[];$(this).prevAll("li").each(function(){h.push($(this).data("id").toString())});b.init({searchInput:true,data:g,claiming:false,selectData:h,dom:$(this),container:$(this),isClose:false,eventType:f});return false});e.panel.on(f,"ul li.add_user_li",function(i,j){var h={operatorType:j&&j.isSelect,ids:j&&j.ids,meetingId:$(this).closest("div.weekly-project").attr("data-meetingId"),callback:j&&j.callback};e.operatorJoninUser(h)});e.panel.on("click","a.remove-member-handler",function(k){layer.closeAll();var j=this,i=[];i.push($(j).closest("li").data("id"));var h={operatorType:false,ids:i,meetingId:$(j).closest("div.weekly-project").attr("data-meetingId"),callback:function(){$(j).closest("li").remove()}};e.operatorJoninUser(h);return false});e.panel.on("click","i.delete_adjunct_i",function(){var h=this;$.ajax({type:"post",url:context+"/meeting/deleteadjunct.htm",data:{fileUrl:$(h).closest("span").attr("data-fileurl"),projectId:e.projectId}}).done(function(i){if(i&&i.success){$(h).closest("span").remove()}else{if(i&&!i.success&&i.errormsg){layer.alert(i.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)});return false});e.panel.on("click","a.add_adjunct_a",function(){$("file_meeting_project_id_hidden").val(this.projectId);e.panel.find("form.file_upload_form").find("input.file_meetingid_input").attr("value",$(this).closest("div.weekly-project").attr("data-meetingId")).end().find("input.file_upload_input").click()});e.panel.on("change","input.file_upload_input",function(){var j=this,i=j.files,h={beforeSubmit:function(){if(!i||i.length>0){if(i[0].limitSize(500,"MB")){layer.alert("附件太大，无法上传，请限制500MB以内");$(j).after($(j).clone(true).val(""));$(j).remove();return false}if(i[0].name.length>80){layer.alert("附件名字过长，应为80以内，请修改后再上传");$(j).after($(j).clone(true).val(""));$(j).remove();return false}return true}return false},success:function(l){if(l&&l.success){var n=l.resultData,k=$(j).siblings("input.file_meetingid_input:first").val(),o=e.panel.find('div.weekly-project[data-meetingId="'+k+'"] li.adjunct_manage');var m=$('<span data-fileurl="'+n.fileUrl+'"><a><i class=" icon-doc-text-1"></i>'+n.fileName+'</a> <i class="icon-cancel-circled delete_adjunct_i" title="删除"></i></span>');o.append(m)}else{if(l&&!l.success&&l.errormsg){layer.alert(l.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(k){layer.alert("请求失败",1)},complete:function(){$(j).after($(j).clone(true).val(""));$(j).remove()}};$(j).closest("form.file_upload_form").ajaxSubmit(h);return false});e.panel.on("click","li.adjunct_manage span",function(){var h=e.panel.find("form.file_download_form");h.find('input[name="fileUrl"]').attr("value",$(this).attr("data-fileurl"));h.find('input[name="remove_cache"]').attr("value",(new Date()).getTime());h.submit().before(h.clone(true).val("")).remove()});e.panel.on("click","#add_meeting_btn, i.icon-pencil",function(){var i=$("<div></div>"),h=-1;if($(this).hasClass("icon-pencil")){h=$(this).closest("div.weekly-project").attr("data-meetingId")}i.load(context+"/meeting/toAddMeeting.htm",{projectId:e.projectId,meetingId:h},function(){var j=-1;j=$.layer({type:1,title:false,area:["auto","500px"],border:[0],shade:[0.8,"#000"],closeBtn:[0,false],shift:["top",500,true],offset:["50px",""],page:{html:i.html()},success:function(k){$(k).on("click",function(l){return false});$(k).on("click",".icon-cancel-circled",function(){layer.close(j)});c.init(k,function(l){e.panel.closest("div[data-id='projectTemplate']").empty().load(context+"/meeting/loadmeetingview.htm",{projectId:e.projectId})})}})});return false});e.panel.on("click","i.icon-trash-empty",function(){var h=$(this).closest("div.weekly-project").attr("data-meetingId");layer.confirm("确定删除吗",function(i){layer.close(i);$.ajax({url:context+"/meeting/deletemeeting.htm",type:"post",data:{meetingId:h}}).done(function(j){if(j&&j.success){layer.alert("删除成功",1);e.panel.closest("div[data-id='projectTemplate']").empty().load(context+"/meeting/loadmeetingview.htm",{projectId:e.projectId})}else{if(j&&!j.success&&j.errormsg){layer.alert(j.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)})},function(i){layer.close(i)});return false});var d="";e.panel.on("click","div.weekly-project button.edit_record",function(){var h=$(this),i=h.closest("div.weekly-project").find("textarea.update_record");i.removeClass("transparent").addClass("form-control").prop("disabled","");h.removeClass("edit_record").addClass("save_record").empty().html("保存纪要");i.trigger("change");d=new InputValidate(i,false,3500);return false});e.panel.on("click","div.weekly-project button.save_record",function(){if(d&&!d.checkValidate()){return false}var i=$(this),j=i.closest("div.weekly-project").find("textarea.update_record"),h=$(this).closest("div.weekly-project").attr("data-meetingId");$.ajax({type:"post",url:context+"/meeting/updatemeetingrecord.htm",data:{meetingId:h,record:j.val()}}).done(function(k){if(k&&k.success){j.empty().html(k.resultData);$(this).prop("disabled",false)}else{if(k&&!k.success&&k.errormsg){layer.alert(k.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)}).always(function(){j.removeClass("form-control").addClass("transparent").prop("disabled","disabled").trigger("change");i.removeClass("save_record").addClass("edit_record").empty().html("编辑纪要")});return false});e.panel.on("change keyup input","textarea.hidden_overflow",function(){var h=$(this);h.css("height","38px").css("height",this.scrollHeight+"px")})},operatorJoninUser:function(e){var d={operatorType:e.operatorType,ids:e.ids,meetingId:e.meetingId};$.ajax({type:"post",data:d,url:context+"/meeting/operatorJoninUser.htm"}).done(function(f){if(f&&f.success){if(e.callback){e.callback()}}else{if(f&&!f.success&&f.errormsg){layer.alert(f.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){})}};a.init()});