define(["jquery"],function(){var a={stageHtml:function(c,g){var j=this,d;var h=(c&&c.tasks)?c.tasks.length:0;var i=(c&&c.doneTasks)?c.doneTasks.length:0;var b=h+i;var f=b==0?"":("· "+b);d="<li class='vertical-scroll' data-id='"+c.taskLineId+"'><div class='top'><h4 class='pull-left'><span class='stageName' title='"+c.name+"'>"+j.getStrActualLen(c.name,20)+"</span><span class='taskCount'>"+f+"</span></h4>";if(!window.readOnly&&$.inArray("TASK_LINE:EDIT",g.permits)>=0){d+="<a href='#' class='pull-right stageMenu'><i class='icon-down-open-big'></i></a>"}var e=window.readOnly?"":"<div class='add-button corner-6 addTaskButton'><a><i class=' icon-plus-circled'></i>新建任务</a></div>";d+="</div><div class='taskAccordion'><h3>未完成的任务<span class='taskCount'>· "+h+"</span></h3><div class='isNoOverWork'><div class='taskList'>"+this.getTaskListData(c.tasks)+"</div>"+e+"<div class='addTaskForm'></div></div><h3>已完成的任务<span class='taskCount'>· "+i+"</span></h3><div class='taskDoneList'>"+this.getDoneTaskListData(c.doneTasks)+"</div></div></li>";return d},getTaskListData:function(e){var b="";if(!e){return b}for(var d=0;d<e.length;d++){var c=e[d];b+=this.taskHtml("0",c)}return b},updateTaskCount:function(d){if($(d).length>0){var c=$(d).find(".taskList").find(".block").length;var e=$(d).find(".taskDoneList").find(".block").length;var b=c+e;if(b==0){$(d).find(".top").find("span.taskCount").text("")}else{$(d).find(".top").find("span.taskCount").text("· "+b)}$(d).find(".taskAccordion").find("h3:eq(0)").find("span").text("· "+c);$(d).find(".taskAccordion").find("h3:eq(1)").find("span").text("· "+e)}},refreshAllTaskCount:function(){var c=this;var b=$("div.main-content[data-id='projectTemplate']");if(b.length>0){$(".main-task",b).find("li.vertical-scroll").each(function(){c.updateTaskCount($(this))})}},getDoneTaskListData:function(e){var b="";if(!e){return b}for(var d=0;d<e.length;d++){var c=e[d];b+=this.taskHtml("1",c)}return b},taskHtml:function(g,f){var b={logo:"",name:""};var e=f.executor;var c=window.projectUserList[e];if(e>0){if(c){b.logo=c.logo;b.name=c.name}}else{b.logo=context+"/static/images/pic-shelters.png";b.name="待认领"}var d=f.priority!=$("#level0Code").val()?"<div title="+$("#level1Text").val()+" class='block "+this.decideTaskPriority(f.priority)+"'":"<div class='block "+this.decideTaskPriority(f.priority)+"'";if($.inArray("TASK:SORT",f.permits)>=0||g=="add"){d+=" data-sort='sort'"}if($.inArray("TASK:MOVE_TO_LINE",f.permits)>=0||g=="add"){d+=" data-line='line'"}d+=" data-id='"+f.taskId+"'>"+this.decideTaskStatus(f.status)+"<a href='#' class='pull-left person-space'  style='margin-left: 20px;'><img src='"+b.logo+"' class='img-circle' title='"+b.name+"'/></a><div class='word' style='margin-left: 55px;'>"+f.content+"</div>";if($.inArray("TASK_CHAT:VIEW",f.permits)>=0||g=="add"){d+="<i class='icon-chat' title='聊天'></i>"}d+="</div>";return d},myTaskHtml:function(b){return"<li data-id='"+b.taskId+"' class='"+this.decideTaskPriority(b.priority)+"'>"+this.decideTaskStatus(b.status)+"<p style='margin-left:14px'>"+b.content+"</p></li>"},childTaskHtml:function(c,e){var f=c[e.executor]?c[e.executor].logo:"";var d=c[e.executor]?c[e.executor].name:"";var b=e.executor?f:(context+"/static/images/pic-shelters.png");return"<li data-id='"+e.taskId+"'><img data-id='"+e.executor+"' title='"+d+"' src='"+b+"' class='img-circle'><span>"+e.content+"</span></li>"},decideTaskPriority:function(b){if(b==$("#level0Code").val()){return"block"}else{return"block block-green"}},decideTaskStatus:function(b){if(b==$("#toCheckCode").val()){return"<div class='taskPriority border-yellow' title="+$("#toCheckText").val()+"></div>"}else{if(b==$("#noPassCode").val()){return"<div class='taskPriority border-red' title="+$("#noPassText").val()+"></div>"}else{if(b==$("#completeCode").val()){return"<div class='taskPriority border-green' title="+$("#completeText").val()+"></div>"}else{return"<div class='taskPriority'></div>"}}}},openTaskInfo:function(d){layer.closeAll();var b=$(d).data("id");if(!b){return false}var c=$(d);c.prop("disabled",true);$.ajax({type:"post",data:{taskId:b},url:context+"/task/findTaskData.htm"}).done(function(i){if(i&&i.success){var h=i.resultData;if(h){c.trigger("taskStatusEvent",[{status:h.status}]);var e=context+"/task/loadTaskInfo.htm",g=true;if(h.status==$("#completeCode").val()|h.status==$("#toCheckCode").val()){e=context+"/task/loadReadOnlyTaskInfo.htm";g=false}if(window.readOnly){e=context+"/task/loadReadOnlyTaskInfo.htm";g=false}var f=$("<div></div>");f.load(e,function(){$.layer({type:1,title:false,area:["auto","auto"],shade:[0],zIndex:6000,border:[0],closeBtn:[0],page:{html:f.html()},success:function(j){if(window.readOnly){$(j).find("#pass,.pass").hide();$(j).find("#waitAudit,.waitAudit").hide();$(j).find("#notPass,.nopass").hide();$(j).find("#taskMenu").hide()}if($.inArray("TASK:DELETE",i.resultData.permits)==-1){$(j).find("#taskMenu").hide()}if($.inArray("TASK:COMMIT",i.resultData.permits)==-1){$(j).find("#waitAudit,.waitAudit").hide()}if($.inArray("TASK_BOARD:ADMIN_ACCESS",i.resultData.permits)==-1&&$.inArray("PRJ:ADMIN_ACCES",i.resultData.permits)==-1&&$.inArray("TASK:PASS",i.resultData.permits)==-1){$(j).find("#pass,.pass").hide()}if($.inArray("TASK_BOARD:ADMIN_ACCESS",i.resultData.permits)==-1&&$.inArray("PRJ:ADMIN_ACCES",i.resultData.permits)==-1&&$.inArray("TASK:NOT_PASS",i.resultData.permits)==-1){$(j).find("#notPass,.nopass").hide()}if($.inArray("TASK:SET",i.resultData.permits)==-1){$(j).find("#addChildTask").hide();$(j).find("#uploadFileBtn").hide();$(j).find("#discussContent").hide();$(j).find("#updateTaskRightLayer").find(".panel-content").css("bottom","0px")}if($.inArray("TASK:UPDATE_MEMBER",i.resultData.permits)==-1){$(j).find("#selectPartner").hide()}if(i.resultData.status==$("#completeCode").val()){$(j).find("#waitAudit,.waitAudit").hide();$(j).find("#pass,.pass").hide();$(j).find("#notPass,.nopass").hide()}if(i.resultData.status==$("#doingCode").val()||i.resultData.status==$("#noPassCode").val()){$(j).find("#pass,.pass").hide();$(j).find("#notPass,.nopass").hide()}if(i.resultData.status==$("#toCheckCode").val()){$(j).find("#waitAudit,.waitAudit").hide()}if(g){$(j).find("#updateTaskRightLayer").data("taskInfo",i.resultData)}else{$(j).find("#updateReadOnlyTaskRightLayer").data("taskInfo",i.resultData)}}})})}}else{if(i&&!i.success){layer.msg(i.errormsg)}else{layer.msg("请求失败")}}c.prop("disabled",false)})},getStrActualLen:function(e,b){var d="";if(e==null||e.length==0){return""}if(e.replace(/[^\x00-\xff]/g,"xx").length>b){for(var c=0;d.replace(/[^\x00-\xff]/g,"xx").length<b;c++){d=e.substring(0,c)}d=d+"..."}else{d=e}return d}};return a});