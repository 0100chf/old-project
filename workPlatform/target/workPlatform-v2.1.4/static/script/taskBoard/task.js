require(["jquery","script/common/personList","script/common/dialogAlert","script/taskBoard/addTaskForm",context+"/static/script/taskBoard/installHtml.js?_T="+(new Date()).valueOf(),"jqueryUI","layer","my97","jqueryForm"],function(c,l,a,j,d){var n=c("#updateTaskRightLayer");var q=n.data("taskInfo");var k=c("#completeCode").val();var s=c("#doingCode").val();var r=c("#toCheckCode").val();var e=c("#noPassCode").val();var h=c("#level0Code").val();var g=c("#level1Code").val();var f=c("#itemCompleteCode").val();var o=c("#visibleStatusAllUser").val();var b=c("#visibleStatusTaskMember").val();var m=c("div.main-content[data-id='projectTemplate']");var i={init:function(){if(c("div.main-content[data-id='projectTemplate']").length>0){this.taskBoardPanel=c("div.main-content[data-id='projectTemplate']")}else{this.personanTaskPanel=c("#personalTaskContainer")}this.taskTitleBar=n.find("#taskTitleBar");this.updateTaskContent=n.find("#updateTaskContent");this.updateRemark=n.find("#updateRemark");this.updateExecutor=n.find("#updateExecutor");this.updateEndDate=n.find("#updateEndDate");this.updateLevel=n.find("#updateLevel");this.visibilityUser=n.find("#visibilityUser");this.status=n.find("#status");this.admin=n.find("#admin");this.createdTime=n.find("#createdTime");this.planTime=n.find("#planTime");this.realityTime=n.find("#realityTime");this.updateCheckItem=n.find("#updateCheckItem");this.updatePartner=n.find("#updatePartner");this.updateChildTask=n.find("#updateChildTask");this.tabContent=n.find("#tabContent");this.initData(q);this.setEvent()},initData:function(v){if(!v){return false}var t=this;this.projectId=v.projectId;this.userList={};if(this.taskBoardPanel){this.taskBlock=this.taskBoardPanel.find(".main-task").find("ul > li[data-id='"+v.taskLine.taskLineId+"']").find(".block[data-id='"+v.taskId+"']");this.listTaskLinesData=this.taskBoardPanel.find(".main-task").data("listTaskLinesData");this.boardList=c("#switchTaskBoard",this.taskBoardPanel).data("taskBoardList");this.boardId=c("#switchTaskBoard",this.taskBoardPanel).data("id");n.data("boardId",this.boardId);this.userList=window.projectUserList;this.initSpecialData()}else{this.taskBlock=this.personanTaskPanel.find("li[data-id='"+v.taskId+"']")}this.taskTitleBar.find("#moveOtherStage").text(d.getStrActualLen(v.taskLine.name,20)).data("id",v.taskLine.taskLineId);if(v.status===r){this.taskTitleBar.find("#waitAudit i").show()}else{if(v.status===k){this.taskTitleBar.find("#pass i").show()}else{if(v.status===e){this.taskTitleBar.find("#notPass i").show()}}}this.updateTaskContent.find("textarea").val(v.content);if(v.remark&&v.remark.length>0){this.updateRemark.find("a").hide();this.updateRemark.find("span").show();this.updateRemark.find("p").text(v.remark)}if(v.dueTime){var u=new Date(v.dueTime);this.updateEndDate.find("input").val(u.getFullYear()+"年"+p(u.getMonth()+1)+"月"+p(u.getDate())+"日")}if(v.createdTime){var u=new Date(v.createdTime);this.createdTime.find("a").text(u.getFullYear()+"年"+p(u.getMonth()+1)+"月"+p(u.getDate())+"日")}if(v.planTime){this.planTime.show();this.planTime.find("a").text(v.planTime)}if(v.realityTime){this.realityTime.show();this.realityTime.find("a").text(v.realityTime)}if(v.visibleStatus==o){this.visibilityUser.find("#changeVisibility").html("所有成员可见")}else{this.visibilityUser.find("#changeVisibility").html("仅参与者可见")}if(v.priority==h){this.updateLevel.find("#changeLevel").html("<i class='icon-record gray'></i>一般")}else{this.updateLevel.find("#changeLevel").html("<i class='icon-record green'></i>紧急")}if(v.status==s){this.status.find("a").text(c("#doingText").val())}else{if(v.status==k){this.status.find("a").text(c("#completeText").val())}else{if(v.status==r){this.status.find("a").text(c("#toCheckText").val())}else{if(v.status==e){this.status.find("a").text(c("#noPassText").val())}}}}this.loadTaskCheckItem(v.taskId);t.tabContent.find("#fileTaskId").val(v.taskId);t.tabContent.find("#uploadProjectId").val(t.projectId);t.tabContent.find("#switchTab span").text(v.noPassTimes);if(v.noPassReason){var w=v.noPassReason.split("|");c.each(w,function(y,z){var x=c("<li>"+z+"</li>");t.tabContent.find("div.nopassReason ul").append(x)});v.noPassReason.split("|")}this.loadChildTask(v.taskId);this.loadDynamicContent(v.taskId);this.loadTaskAttachments(v.taskId);if(!this.taskBoardPanel){this.getTaskRelatedData()}},getUserInfo:function(w){var u=this;var v={logo:"",name:""};var t=u.userList[w];if(w>0){if(t){v.logo=t.logo;v.name=t.name}}else{v.logo=context+"/static/images/pic-shelters.png";v.name="待认领"}return v},initSpecialData:function(){var u=this;var v=q;if(v.executor>0){var t=u.getUserInfo(v.executor);u.updateExecutor.find("a").html("<img data-id='"+v.executor+"' src='"+t.logo+"' class='img-circle'>"+t.name)}if(v.admin>0){var t=u.getUserInfo(v.admin);u.admin.find("a").html("<img data-id='"+v.admin+"' src='"+t.logo+"' class='img-circle'>"+t.name)}var w="";if(v.partnerIds&&v.partnerIds.length>0){c.each(v.partnerIds,function(x,z){var y=u.getUserInfo(z);w+="<li data-id='"+z+"' title='"+y.name+"'><img src='"+y.logo+"' class='img-circle'>";if(c.inArray("TASK:UPDATE_MEMBER",q.permits)>=0){w+="<a class='remove-member-handler'>×</a>"}w+="</li>"})}this.updatePartner.find("ul").prepend(w);c.each(u.boardList,function(x,y){if(y.taskBoardId==u.boardId){u.taskTitleBar.find("#moveOtherTaskgroup").text(d.getStrActualLen(y.name,20)).data("id",u.boardId);return false}})},reloadUserPic:function(){var t=this;if(t.userList){n.find("img.img-circle[src='']").each(function(){var u=t.getUserInfo(c(this).data("id"));c(this).attr("src",u.logo).attr("title",u.name);c(this).next("a").text(u.name)})}},getTaskRelatedData:function(){var t=this;c.ajax({type:"POST",url:context+"/task/findTaskOtherData.htm",data:{projectId:t.projectId,taskId:q.taskId}}).done(function(u){if(u&&u.success&&u.resultData){t.listTaskLinesData=u.resultData.lineList;t.boardList=u.resultData.boardList;t.boardId=u.resultData.boardId;t.userList=u.resultData.userList;n.data("boardId",t.boardId);t.initSpecialData();t.reloadUserPic()}else{layer.msg(u.errormsg)}}).fail(function(){layer.msg("请求失败")})},loadDynamicContent:function(u){var t=this;c.ajax({type:"post",data:{taskId:u},url:context+"/task/listTaskActionRecords.htm"}).done(function(w){if(w&&w.success){var x="";if(w.resultData){for(var v=0;v<w.resultData.length;v++){x+=t.activityHtml(w.resultData[v])}n.find("#activityContent").append(x);if(t.taskBoardPanel){t.reloadUserPic()}}}else{if(resultData&&!resultData.success){layer.msg(resultData.errormsg)}else{layer.msg("请求失败")}}})},loadTaskCheckItem:function(u){var t=this;c.ajax({type:"post",data:{taskId:u},url:context+"/task/findTaskCheckList.htm"}).done(function(B){if(B&&B.success){var A="";var z=0;if(B.resultData){var v=B.resultData.length;if(v>0){var x=0;for(var y=0;y<v;y++){var C=B.resultData[y];if(C.status==f){x++;A+="<li data-id='"+C.taskCheckListId+"'><span class='check-box'><i class='icon-ok'></i></span><span class='checkItemContent'>"+C.listContent+"</span></li>"}else{A+="<li data-id='"+C.taskCheckListId+"'><span class='check-box'><i class='icon-ok' style='display:none'></i></span><span class='checkItemContent'>"+C.listContent+"</span></li>"}}t.updateCheckItem.find("ul.check-item").append(A);z=parseInt((x/v)*100)}}var w=c("#progressbar").progressbar({value:z}).css({height:15,background:"#CFCFCF"});w.find(".progress-label").html(z+"%&nbsp;")}else{if(resultData&&!resultData.success){layer.msg(resultData.errormsg)}else{layer.msg("请求失败")}}})},loadChildTask:function(u){var t=this;c.ajax({type:"post",data:{taskId:u},url:context+"/task/findParentAndChildTask.htm"}).done(function(y){if(y&&y.success){if(y.resultData){if(y.resultData.parentTask){t.updateChildTask.find("#parentTask").find("ul").append(d.childTaskHtml(t.userList,y.resultData.parentTask))}else{t.updateChildTask.find("#parentTask").find("ul").text("无")}var w=y.resultData.children.length;if(w>0){var v="";for(var x=0;x<w;x++){var z=y.resultData.children[x];v+=d.childTaskHtml(t.userList,z)}t.updateChildTask.find("#childTask").find("ul").append(v)}else{t.updateChildTask.find("#childTask").find("ul").text("无")}}else{t.updateChildTask.find("#parentTask").find("ul").text("无");t.updateChildTask.find("#childTask").find("ul").text("无")}if(t.taskBoardPanel){t.reloadUserPic()}}else{if(resultData&&!resultData.success){layer.msg(resultData.errormsg)}else{layer.msg("请求失败")}}})},loadTaskAttachments:function(u){var t=this;c.ajax({type:"post",data:{taskId:u},url:context+"/task/findAttachments.htm"}).done(function(x){if(x&&x.success){var v="";if(x.resultData){for(var w=0;w<x.resultData.length;w++){v+=t.fileHtml(x.resultData[w])}n.find("#taskFileContend").append(v);if(t.taskBoardPanel){t.reloadUserPic()}}}else{if(resultData&&!resultData.success){layer.msg(resultData.errormsg)}else{layer.msg("请求失败")}}})},loadDiscuss:function(u){var t=this;c.ajax({type:"post",data:{taskId:u},url:context+"/task/findTaskDiscuss.htm"}).done(function(w){if(w&&w.success){var x="";if(w.resultData){for(var v=0;v<w.resultData.length;v++){x+=t.discussHtml(w.resultData[v])}n.find("#taskMessage").append(x);if(t.taskBoardPanel){t.reloadUserPic()}}}else{if(resultData&&!resultData.success){layer.msg(resultData.errormsg)}else{layer.msg("请求失败")}}})},groupIndex:"",stageIndex:"",stageMenuIndex:"",closeAllLayer:function(){c("#selectUserLayer").closest(".xubox_layer").remove();n.find("#alterContentArea").remove();this.regainRemark(n.find("#updateRemark").find("p").text());this.updateChildTask.find("#addChildTaskForm").empty();layer.close(this.groupIndex);layer.close(this.stageIndex);layer.close(this.stageMenuIndex);n.find("#updateCheckItem").find("li").show();this.updateLevel.find("ul").hide()},updateTaskLastData:function(t,u){q[t]=u;n.data("taskInfo",q)},taskMenuHtml:function(){return"<div class='layer-lg200 boardBackground floatLayer'><div class='layer-title'><h5>任务菜单</h5><i class='icon-cancel-circled-outline'></i></div><ul><li  id='deleteTask'><a> <i class='icon-pencil'></i>删除任务</a></li></ul></div>"},taskMenuEvent:function(t){var u=this;c(t).on("click",function(){return false});c(t).on("click",".icon-cancel-circled-outline",function(){layer.close(layer.index)});c(t).on("click",".icon-left-open-big",function(){c(t).find(".floatLayer").replaceWith(u.taskMenuHtml())});c(t).on("click","li#deleteTask",function(){c(t).find(".floatLayer").html("<div class='layer-title'><h5>删除任务</h5><i class=' icon-left-open-big'></i><i class='icon-cancel-circled-outline'></i></div><ul><li>您确定要删除这个任务吗?</li><li><button id='deleteSave' class='btn red btn-common'>删除</button></li></ul>");return false});c(t).on("click","#deleteSave",function(){var v=q.taskId;c.ajax({type:"post",data:{taskId:v},url:context+"/task/delTask.htm"}).done(function(w){if(w&&w.success){u.taskBlock.trigger("deleteEvent");layer.closeAll()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}});return false})},updateCheckItemProgressbar:function(){var u=this.updateCheckItem.find("ul.check-item").children().length;var t=this.updateCheckItem.find("ul.check-item").find("i.icon-ok:visible").length;var v;if(u==0){v=0}else{v=parseInt((t/u)*100)}c("#progressbar").progressbar({value:v});c("#progressbar").find(".progress-label").html(v+"%&nbsp;");return false},setEvent:function(){var t=this;n.on("click",function(u){t.closeAllLayer();EventUtil.stopPropagation(u)});this.taskTitleBar.find("#taskMenu").on("click",function(){var v=c(this).offset().top+c(this).height()+5+"px";var u=c(this).offset().left-120+"px";t.stageMenuIndex=c.layer({type:1,title:false,area:["auto","auto"],offset:[v,u],border:[0],shade:[0,"#FFFFFF"],closeBtn:[0],page:{html:t.taskMenuHtml()},success:function(w){t.taskMenuEvent(w)}});return false});this.taskTitleBar.on("click","#moveOtherTaskgroup",function(){if(c.inArray("TASK:MOVE_TO_BOARD",q.permits)==-1){return}t.closeAllLayer();var u=c(this).offset();var w=u.top+c(this).height()+10+"px";var v=u.left-50+"px";t.groupIndex=c.layer({type:1,title:false,area:["auto","auto"],offset:[w,v],shade:[0],border:[0],closeBtn:[0],page:{html:t.taskGroupListHtml(t.boardList).html()},success:function(x){c(x).on("click",function(){return false});c(x).on("click",".panel-heading",function(){c(this).closest(".panel-default").siblings().find(".panel-collapse").removeClass("in");if(c(this).next().hasClass("in")){c(this).next().removeClass("in")}else{c(this).next().addClass("in")}});c(x).on("click","li",function(){var B=c(this).closest(".panel-collapse").prev("div").data("id");var y=c(this).data("id");var z=c(this).closest(".panel-collapse").prev("div").text();var C=q.taskLine.taskLineId;if(y!=C){var A=q.taskId;c.ajax({type:"post",data:{oneselfId:A,targetId:0,oneselfLineId:0,targetLineId:y},url:context+"/task/moveTask.htm"}).done(function(D){if(D&&D.success){t.taskBlock.trigger("moveToOtherBoardEvent",[{targetLineId:B,targetLineName:z,status:q.status,selfLineId:C}]);layer.closeAll()}else{if(D&&!D.success){layer.msg(D.errormsg)}else{layer.msg("请求失败")}}})}else{layer.close(layer.index)}return false})}});return false});this.taskTitleBar.on("click","#moveOtherStage",function(){if(c.inArray("TASK:MOVE_TO_LINE",q.permits)==-1){return}t.closeAllLayer();var u=c(this).offset();var w=u.top+c(this).height()+10+"px";var v=u.left-50+"px";t.stageIndex=c.layer({type:1,title:false,area:["auto","auto"],offset:[w,v],shade:[0],border:[0],closeBtn:[0],page:{html:t.stageListHtml(t.listTaskLinesData)},success:function(x){c(x).on("click",function(){return false});c(x).on("click","li",function(){var y=c(this).data("id");var B=q.taskLine.taskLineId;if(y!=B){var A=q.taskId;var z=c(this).text();c.ajax({type:"post",data:{oneselfId:A,targetId:0,oneselfLineId:0,targetLineId:y},url:context+"/task/moveTask.htm"}).done(function(C){if(C&&C.success){t.taskBlock.trigger("moveToOtherLineEvent",[{targetLineId:y,targetLineName:z,status:q.status,selfLineId:B}]);layer.closeAll()}else{if(C&&!C.success){layer.msg(C.errormsg)}else{layer.msg("请求失败")}}})}else{layer.close(layer.index)}return false})}});return false});this.taskTitleBar.on("click","#waitAudit",function(){if(c.inArray("TASK:COMMIT",q.permits)==-1){layer.msg("没有权限");return}var v=c(this);var u=v.find("i").is(":hidden")?r:s;c.ajax({type:"post",data:{taskId:q.taskId,status:u},url:context+"/task/updateTaskStatus.htm"}).done(function(w){if(w&&w.success){if(u===r){v.find("i").show()}else{v.find("i").hide()}t.taskBlock.trigger("taskStatusEvent",[{status:u}]);layer.closeAll()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}}).fail(function(){layer.msg("请求失败")});return false});this.taskTitleBar.on("click","#pass",function(){var u=c(this);if(!u.find("i").is(":hidden")){return}if(c.inArray("TASK:PASS",q.permits)==-1){layer.msg("没有权限");return}layer.confirm("是否通过审核？确定后，该任务就完成了，不可再恢复状态了。",function(){c.ajax({type:"post",data:{taskId:q.taskId,status:k},url:context+"/task/updateTaskStatus.htm"}).done(function(w){if(w&&w.success){u.find("i").show();u.siblings("#notPass").find("i").hide();var v=m.find(".block[data-id="+q.taskId+"]");t.taskBlock.trigger("taskStatusEvent",[{status:k}]);v.find("i.icon-ok").show();v.appendTo(v.closest("li").find(".taskDoneList"));d.updateTaskCount(v.closest("li"));layer.closeAll()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}})})});this.taskTitleBar.on("click","#notPass",function(){var v=c(this);if(!v.find("i").is(":hidden")){return}if(c.inArray("TASK:NOT_PASS",q.permits)==-1){layer.msg("没有权限");return}var u=c("<div></div>");u.load(context+"/task/loadNoPassReason.htm",function(){c.layer({type:1,shadeClose:false,title:false,closeBtn:[0,false],shade:[0.3,"#000"],border:[0],offset:["200px",""],area:["450px","203px"],page:{html:u.html()},success:function(w){c(w).on("click",function(){return false});c(w).on("click",".icon-cancel-circled",function(){layer.close(layer.index)});var y=c(w).find("#reason");var x=new InputValidate(y,true,500,0,"verticalline",null);c(w).on("click","#addReason",function(){if(!x.checkValidate()){return false}c.ajax({type:"post",data:{taskId:q.taskId,status:e,noPassReason:y.val()},url:context+"/task/updateTaskStatus.htm"}).done(function(z){if(z&&z.success){v.find("i").show();v.siblings("#pass").find("i").hide();t.taskBlock.trigger("taskStatusEvent",[{status:e}]);layer.closeAll()}else{if(z&&!z.success){layer.msg(z.errormsg)}else{layer.msg("请求失败")}}}).fail(function(){layer.msg("请求失败")});return false})}})})});this.updateTaskContent.on("blur","textarea",function(){if(c.inArray("TASK:SET",q.permits)==-1){layer.msg("没有权限");return}t.closeAllLayer();var w=c(this).val();var v={};v=new InputValidate(c(this),true,500,0,"",null);var u={taskId:q.taskId,value:w,columnName:"content"};if(!v.checkValidate()){return}c.ajax({type:"post",data:u,url:context+"/task/updateTask.htm"}).done(function(x){console.log(x);if(x&&x.success){t.taskBlock.trigger("taskContentEvent",[{content:w}]);t.updateTaskLastData("content",w)}else{if(x&&!x.success){layer.msg(x.errormsg)}else{layer.msg("请求失败")}}});return false});this.updateRemark.on("click","a",function(){t.closeAllLayer();t.alterRemarkEvent("add");return false});this.updateRemark.on("click","p",function(){t.closeAllLayer();if(c(this).text()==""){return false}else{t.alterRemarkEvent("edit")}return false});this.admin.on("click","a",function(){if(c.inArray("TASK:UPDATE_ADMIN",q.permits)==-1){return}var v=c(this).find("img").data("id").toString();var u="changeExecutor";l.init({searchInput:true,data:t.userList,claiming:false,selectData:[v],dom:c(this),container:c(this),isClose:true,eventType:u});c(this).off(u).on(u,function(x,y){var w={taskId:q.taskId,admin:y.ids[0],};c.ajax({type:"post",data:w,url:context+"/task/updateTaskAdmin.htm"}).done(function(z){if(z&&z.success){t.updateTaskLastData("admin",w.admin);y.callback();layer.closeAll()}else{if(z&&!z.success){layer.msg(z.errormsg)}else{layer.msg("请求失败")}}})});return false});this.updateExecutor.on("click","span",function(){if(c.inArray("TASK:UPDATE_EXECUTOR",q.permits)==-1){return}t.closeAllLayer();var x=c(this).find("img").data("id").toString();var v="changeExecutor";var w=c.extend(true,{},t.userList);for(var u in w){if(w[u].prjRoleCode=="PRJ_SUPERVISER"){delete w[u]}}l.init({searchInput:true,data:w,claiming:true,selectData:[x],dom:c(this),container:c(this),isClose:true,eventType:v});c(this).off(v).on(v,function(z,A){var y={taskId:q.taskId,executor:A.ids[0]};c.ajax({type:"post",data:y,url:context+"/task/updateTaskExecutor.htm"}).done(function(B){if(B&&B.success){t.taskBlock.trigger("taskExecutorEvent",[{executor:y.executor}]);t.updateTaskLastData("executor",y.userId);A.callback();layer.closeAll()}else{if(B&&!B.success){layer.msg(B.errormsg)}else{layer.msg("请求失败")}}})});return false});this.updateEndDate.on("focus","input",function(){var v=t.createdTime.find("label").text();if(c.inArray("TASK:SET_DATE",q.permits)==-1){return}t.closeAllLayer();var u={};u.taskId=q.taskId;u.columnName="due_time";WdatePicker({errDealMode:1,dateFmt:"yyyy年MM月dd日",qsEnabled:false,isShowOK:false,minDate:v,onpicking:function(x){var w=x.cal.getNewDateStr();t.updateEndDate.find("input").val(w);$dp.hide();u.value=w.replace(/[年月]/g,"-").replace("日","");c.ajax({type:"post",data:u,url:context+"/task/updateTask.htm"}).done(function(y){if(y&&y.success){t.updateTaskLastData("dueTime",new Date(u.value))}else{if(y&&!y.success){layer.msg(y.errormsg)}else{layer.msg("请求失败")}}});return true},onclearing:function(){t.updateEndDate.find("input").val("");$dp.hide();u.value=null;c.ajax({type:"post",data:u,url:context+"/task/updateTask.htm"}).done(function(w){if(w&&w.success){t.updateTaskLastData("dueTime","")}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}});return true}});return false});this.updateLevel.on("click","#changeLevel",function(){if(c.inArray("TASK:PRIORITY",q.permits)==-1){return}t.closeAllLayer();if(c(this).text()=="一般"){t.updateLevel.find("ul").find("li:eq(0) .icon-ok").show();t.updateLevel.find("ul").find("li:eq(1) .icon-ok").hide()}else{t.updateLevel.find("ul").find("li:eq(1) .icon-ok").show();t.updateLevel.find("ul").find("li:eq(0) .icon-ok").hide()}t.updateLevel.find("ul").show();return false});this.visibilityUser.on("click","#changeVisibility",function(){if(c.inArray("TASK:VISIBLE",q.permits)==-1){return}t.closeAllLayer();if(c(this).text()=="仅参与者可见"){t.visibilityUser.find("ul").find("li:eq(0) .icon-ok").show();t.visibilityUser.find("ul").find("li:eq(1) .icon-ok").hide()}else{t.visibilityUser.find("ul").find("li:eq(1) .icon-ok").show();t.visibilityUser.find("ul").find("li:eq(0) .icon-ok").hide()}t.visibilityUser.find("ul").show();return false});this.visibilityUser.find("ul").on("click","li",function(){var u=c(this);var v={taskId:q.taskId,columnName:"visible_status"};if(c(this).index()!=0){v.value=o}else{v.value=b}c.ajax({type:"post",data:v,url:context+"/task/updateTask.htm"}).done(function(w){if(w&&w.success){t.updateTaskLastData("visibleStatus",v.value);t.visibilityUser.find("#changeVisibility").html(u.find("a").html());t.visibilityUser.find("ul").hide()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}});return false});this.updateLevel.find("ul").on("click","li",function(){var u=c(this);var v={taskId:q.taskId,columnName:"priority"};if(c(this).index()==0){v.value=h}else{v.value=g}c.ajax({type:"post",data:v,url:context+"/task/updateTask.htm"}).done(function(w){if(w&&w.success){t.taskBlock.trigger("taskPriorityEvent",[{priority:v.value}]);t.updateTaskLastData("priority",v.value);t.updateLevel.find("#changeLevel").html(u.find("a").html());t.updateLevel.find("ul").hide()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}});return false});this.updateCheckItem.on("click","li span.check-box",function(){if(c.inArray("TASK:SET",q.permits)==-1){layer.msg("没有权限");return}t.closeAllLayer();var v=c(this).closest("li").data("id");var u;if(c(this).find("i").is(":hidden")){u=true;c(this).find("i").show()}else{u=false;c(this).find("i").hide()}c.ajax({type:"post",data:{taskCheckListId:v,value:u,columnName:"status"},url:context+"/task/updateTaskCheckList.htm"}).done(function(w){if(w&&w.success){t.updateCheckItemProgressbar()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}});return false});this.updateCheckItem.on("click","ul > li",function(){t.closeAllLayer();var u=c(t.alterAndDeleteAreaHtml()).insertAfter(c(this));var x=c(this);var w=x.data("id");u.find("textArea").val(x.text());x.hide();var v=new InputValidate(u.find("textarea"),true,600);u.on("click",".btn-sure",function(){if(c.inArray("TASK:SET",q.permits)==-1){layer.msg("没有权限");return}var y=t.updateCheckItem.find("textarea").val();if(!v.checkValidate()){return false}c.ajax({type:"post",data:{taskCheckListId:w,value:y,columnName:"list_content"},url:context+"/task/updateTaskCheckList.htm"}).done(function(z){if(z&&z.success){x.find("span:eq(1)").text(y);x.show();u.remove()}else{if(z&&!z.success){layer.msg(z.errormsg)}else{layer.msg("请求失败")}}});return false});u.on("click",".btn-cancel",function(){if(c.inArray("TASK:SET",q.permits)==-1){layer.msg("没有权限");return}c.ajax({type:"post",data:{taskCheckListId:w},url:context+"/task/delTaskCheckList.htm"}).done(function(y){if(y&&y.success){x.remove();u.remove();t.updateCheckItemProgressbar()}else{if(y&&!y.success){layer.msg(y.errormsg)}else{layer.msg("请求失败")}}});return false});u.on("click",function(){return false});return false});this.updateCheckItem.on("click","a",function(){t.closeAllLayer();var u=c(t.alterAreaHtml()).appendTo(t.updateCheckItem);u.find("textarea").focus();n.find(".panel-content").animate({scrollTop:230},500);u.on("click",".btn-sure",function(){var v=new InputValidate(u.find("textarea"),true,600);if(c.inArray("TASK:SET",q.permits)==-1){layer.msg("没有权限");return}var w=u.find("textarea");if(!v.checkValidate()){return false}c.ajax({type:"post",data:{taskId:q.taskId,content:w.val()},url:context+"/task/addCheckList.htm"}).done(function(x){if(x&&x.success){t.updateCheckItem.find(".check-item").append("<li data-id='"+x.resultData+"'><span class='check-box'><i class='icon-ok' style='display:none'></i></span><span>"+w.val()+"</span></li>");t.updateCheckItemProgressbar();w.val("")}else{if(x&&!x.success){layer.msg(x.errormsg)}else{layer.msg("请求失败")}}});return false});u.on("click",".btn-cancel",function(){alterRemark.remove()});u.on("click",function(){return false});return false});this.updatePartner.on("click","#selectPartner",function(){t.closeAllLayer();var v="partnerChange";var u=[];c(this).prevAll("li").each(function(){u.push(c(this).data("id").toString())});l.init({searchInput:true,data:t.userList,everyone:true,selectData:u,dom:c(this),container:c(this),eventType:v});c(this).off(v).on(v,function(x,y){var w={taskId:q.taskId,partner:y.ids,isSelected:y.isSelect};c.ajax({type:"post",data:w,url:context+"/task/updateTaskPartner.htm"}).done(function(z){if(z&&z.success){y.callback()}else{if(z&&!z.success){layer.msg(z.errormsg)}else{layer.msg("请求失败")}}})});return false});this.updatePartner.on("click","li .remove-member-handler",function(){var u=c(this).closest("li");var v={taskId:q.taskId,partner:[u.data("id")],status:false};c.ajax({type:"post",data:v,url:context+"/task/updateTaskPartner.htm"}).done(function(w){if(w&&w.success){u.remove()}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}})});this.updateChildTask.on("click","#addChildTask",function(){t.closeAllLayer();j.init(t.userList,c(this).closest("div").find("#addChildTaskForm"));n.find(".panel-content").animate({scrollTop:364},500);return false});this.updateChildTask.on("click","ul.check-item li",function(){d.openTaskInfo(c(this));return false});this.tabContent.find("#switchTab").on("click","li",function(){t.closeAllLayer();if(c(this).hasClass("active")){return false}c(this).addClass("active").siblings().removeClass("active");var u=c(this).index();if(u==0){t.tabContent.find(".activity-detail").show();t.tabContent.find(".nopassReason").hide();t.tabContent.find(".tab-accessory").hide();n.find(".panel-content").css("bottom","0px")}else{if(u==1){t.tabContent.find(".activity-detail").hide();t.tabContent.find(".tab-accessory").show();t.tabContent.find(".nopassReason").hide();n.find(".panel-content").css("bottom","0px")}else{if(u==2){t.tabContent.find(".activity-detail").hide();t.tabContent.find(".tab-accessory").hide();t.tabContent.find(".nopassReason").show()}}}});this.tabContent.on("click","#uploadFileBtn",function(){t.tabContent.find("#uploadFileInput").trigger("click");return false});this.uploadFile();return false},taskGroupListHtml:function(u){var v=c('<div><div class="layer-lg boardBackground floatLayer " style="padding:0px 0px"><div class="panel-group fold-group" id="accordion"></div></div></div>');if(u&&u.length>0){var t=this.taskTitleBar.find("#moveOtherStage").data("id");var w=this.taskTitleBar.find("#moveOtherTaskgroup").data("id");c.each(u,function(y,z){var A=c('<div class="panel panel-default"></div>');var x="collapse"+y;if(w==z.taskBoardId){A.append('<div data-id="'+z.taskBoardId+'" class="panel-heading"><h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion" href="#'+x+'">'+z.name+'</a></h4></div><div id="'+x+'" class="panel-collapse collapse in"><div class="panel-body"><ul></ul></div></div>')}else{A.append('<div data-id="'+z.taskBoardId+'"class="panel-heading"><h4 class="panel-title"><a data-toggle="collapse" data-parent="#accordion" href="#'+x+'">'+z.name+'</a></h4></div><div id="'+x+'" class="panel-collapse collapse"><div class="panel-body"><ul></ul></div></div>')}if(z.taskLines){c.each(z.taskLines,function(B,C){if(C.taskLineId==t){A.find("ul").append('<li data-id="'+C.taskLineId+'"><a>'+C.name+'</a><i class=" icon-ok"></i></li>')}else{A.find("ul").append('<li data-id="'+C.taskLineId+'"><a>'+C.name+"</a></li>")}})}else{A.find("#"+x).remove()}v.find("#accordion").append(A)})}return v},stageListHtml:function(t){var u="<div class='layer-sm-noscroll boardBackground floatLayer little-portrait'>";u+="<ul class='vertical-scroll-min scroll-area'>";if(t){var v=this.taskTitleBar.find("#moveOtherStage").data("id");c.each(t,function(w,x){if(v==x.taskLineId){u+="<li data-id='"+x.taskLineId+"'>"+x.name+"<i class='icon-ok''></i></li>"}else{u+="<li data-id='"+x.taskLineId+"'>"+x.name+"<i class='icon-ok' style='display:none'></i></li>"}})}u+="</ul></div>";return u},regainRemark:function(t){if(t==""){this.updateRemark.find("span").hide();this.updateRemark.find("a").show()}else{this.updateRemark.find("a").hide();this.updateRemark.find("span,p").show()}},alterRemarkEvent:function(v){var u=this;var w=c(u.alterAreaHtml()).appendTo(this.updateRemark);this.updateRemark.find("a,p").hide();this.updateRemark.find("span").show();if(v=="add"){}else{w.find("textarea").val(this.updateRemark.find("p").text())}var t=new InputValidate(w.find("textarea"),false,600);w.on("click",".btn-sure",function(){if(c.inArray("TASK:SET",q.permits)==-1){layer.msg("没有权限");return}var y=u.updateRemark.find("textarea").val();if(!t.checkValidate()){return false}var x={taskId:q.taskId,value:y,columnName:"remark"};c.ajax({type:"post",data:x,url:context+"/task/updateTask.htm"}).done(function(z){if(z&&z.success){u.updateRemark.find("p").text(y);u.regainRemark(y);u.updateTaskLastData("remark",y);w.remove()}else{if(z&&!z.success){layer.msg(z.errormsg)}else{layer.msg("请求失败")}}});return false});w.on("click",".btn-cancel",function(){if(u.updateRemark.find("p").text().length){u.updateRemark.find("span").show();u.updateRemark.find("a").hide()}else{u.updateRemark.find("a").show();u.updateRemark.find("span").hide()}u.updateRemark.find("p").show();w.remove()});w.on("click",function(){return false})},alterAreaHtml:function(){return"<div id='alterContentArea'><textarea class='form-control'></textarea><div style='padding-top:3px; height:40px'><button class='btn btn-cancel'>取消 </button><button class='btn btn-sure'> 确定 </button></div></div>"},alterAndDeleteAreaHtml:function(){return"<div id='alterContentArea'><textarea class='form-control'></textarea><div style='padding-top:3px; height:40px'><button class='btn btn-cancel'>删除 </button><button class='btn btn-sure'> 确定 </button></div></div>"},activityHtml:function(v){var u=this;var t=u.getUserInfo(v.userId);var w="";w+="<li>";w+="<img data-id='"+v.userId+"' src='"+t.logo+"' class='img-circle'><a>"+t.name+" </a> <time class='pull-right'>"+new Date(v.createdTime).format("YYYY-MM-dd hh:mm:ss")+"</time>";w+="<ul class='accessory-area'>";w+="<li>";w+="<div>"+v.record+"</div>";w+="</li>";w+="</ul>";w+="</li>";return w},discussHtml:function(v){var u=this;var t=u.getUserInfo(v.createdBy);var w="";w+="<li>";w+="<img data-id='"+v.createdBy+"' src='"+t.logo+"' class='img-circle'><a>"+t.name+" </a> <time class='pull-right'>"+new Date(v.createdTime).format("YYYY-MM-dd hh:mm:ss")+"</time>";w+="<ul class='accessory-area'>";w+="<li>";w+="<div>"+v.content+"</div>";w+="</li>";w+="</ul>";w+="</li>";return w},fileHtml:function(v){var u=this;var t=u.getUserInfo(v.createdBy);var w="";w+="<li>";w+="<img data-id='"+v.createdBy+"' src='"+t.logo+"' class='img-circle'><a>"+t.name+"</a> <time class='pull-right'>"+new Date().format("YYYY-MM-dd hh:mm:ss")+"</time>";w+="<ul class='accessory-area'>";w+="<li>";w+="<span name='taskFile' data-fileUrl='"+v.fileUrl+"'><a><i class=' icon-doc-text-1'></i>"+v.fileName+"</a> <i class='icon-cancel-circled' title='删除'></i></span>";w+="</li>";w+="</ul>";w+="</li>";return w},uploadFile:function(){var t=this;n.find("#taskFileContend").on("click","li span[name='taskFile']",function(){var u=n.find("#downLoadFileForm");u.find('input[name="fileUrl"]').val(c(this).data("fileurl"));u.find('input[name="remove_cache"]').val((new Date()).getTime());u.submit().before(u.clone(true).val("")).remove()});n.find("#taskFileContend").on("click","i.icon-cancel-circled",function(){var u=c(this);c.ajax({type:"post",url:context+"/task/deleteTaskAdjunct.htm",data:{fileUrl:u.closest("span").data("fileurl"),projectId:t.projectId}}).done(function(v){if(v&&v.success){if(u.closest("li").children().length>1){u.closest("span").remove()}else{u.closest("ul").closest("li").remove()}}else{if(v&&!v.success&&v.errormsg){layer.alert(v.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)});return false});n.on("change","#uploadFileInput",function(){var v=this.files;var w=c(this);var u={beforeSubmit:function(){if(!v||v.length>0){if(v[0].limitSize(20,"MB")){a.alert("附件太多，无法上传，请限制20MB以内");w.val("");return false}return true}return false},success:function(x){if(x&&x.success){c(t.fileHtml(x.resultData)).appendTo(n.find("#taskFileContend"))}else{if(x&&!x.success&&x.errormsg){layer.alert(x.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(x){layer.alert("请求失败",1)}};n.find("#uploadFileForm").ajaxSubmit(u);return false})}};function p(t){return t>=10?t:("0"+t)}i.init();return i});