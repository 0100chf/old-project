require(["jquery","script/common/dialogAlert","jqueryForm","layer","my97"],function(a,c){var b;b={init:function(){this.prologo="";this.projectSetting=a("#projectSetting");this.navJustified=a(".nav-justified",this.projectSetting);this.panel=a(".main-project");this.proInfo=a("#proInfo",this.projectSetting);this.projectId=this.proInfo.find("#proId");this.linkBtn=a("#link_btn",this.projectSetting);this.closeLink=a("#close_link",this.projectSetting);this.openLink=a("#open_link",this.projectSetting);this.email=a("#add_user_ByEmail",this.projectSetting);this.teamsList=a("#teams_list ul",this.projectSetting);this.orgId=this.projectSetting.find("#orgId").attr("value");this.proInfoValiArray={};this.initProInfo();this.setEvent();this.userManBtn();this.orgProUserMan()},initProInfo:function(){var d=this,h=a("#proLogo",this.projectSetting),g=a("#update_pro_info",this.projectSetting),e=d.proInfo.find("#proName"),f=d.proInfo.find("#description");d.prologo=a(".img120",this.projectSetting).attr("src");if(!d.proInfoValiArray.name){d.proInfoValiArray.name=new InputValidate(e,true,30,0,"text",null)}else{d.proInfoValiArray.name.target.removeClass("error")}if(!d.proInfoValiArray.description){d.proInfoValiArray.description=new InputValidate(f,false,500,0,"",null)}else{d.proInfoValiArray.description.target.removeClass("error")}h.on("click",function(i){a(this).prop("disabled",true);a("#inputLogo",d.projectSetting).trigger("click")});a("#inputLogo",this.projectSetting).change(function(l){var n=a(this);var k=this.files;if(k.length!=0){var j=k[0],i=new FileReader();if(!i){c.alert("该浏览器不支持头像上传");return false}var m=new RegExp("image/(png|jpeg|jpg|gif|img|)","g");if(!m.test(j.type)){c.alert("请选择正确格式的图片");n.after(n.clone(true).val(""));n.remove();a(".img120",this.projectSetting).attr("src",d.prologo);return false}if(j.limitSize("65","KB")){n.after(n.clone(true).val(""));n.remove();c.alert("图片太大，应65KB以内");a(".img120",this.projectSetting).attr("src",d.prologo);return false}i.onload=function(o){var p=EventUtil.getTarget(o);a(".img120").prop("src",p.result)};i.readAsDataURL(j)}h.prop("disabled",false)});g.on("click",function(){var i={beforeSubmit:function(){var j=false;a.each(d.proInfoValiArray,function(k,l){if(!l.checkValidate()){j=true;return false}});if(j){g.prop("disabled",false);return false}return true},success:function(j){if(j&&j.success){window.location=context+"/project/home.htm";return false}else{if(j&&!j.success){layer.alert(j.errormsg,1)}else{layer.alert(j,1)}}},error:function(){layer.alert("请求失败",1)}};a("#updateProjectForm",d.projectSetting).ajaxSubmit(i);return false});a("#input_logo").val(a("#proLogo").attr("src"));return false},setEvent:function(){var d=this;d.navJustified.on("click","li",function(){if(a(this).hasClass("active")){return false}var e=a(this).siblings("li").removeClass("active").end().addClass("active").data("type");d.hideOrShowSettingPage(e);return false})},hideOrShowSettingPage:function(e){var d=this,f=d.projectSetting.find("#advanced-settings"),g=d.projectSetting.find("#add-member");if(e=="projectInfo"){d.projectSetting.find("span.boardBackground").show();d.proInfo.removeClass("tohide");g.addClass("tohide");f.addClass("tohide");return false}else{if(e=="userMan"){d.projectSetting.find("span.boardBackground").hide();d.proInfo.addClass("tohide");f.addClass("tohide");d.initUserMana();d.usersList();g.removeClass("tohide");if(d.orgId==0){d.projectSetting.find("#user_list").removeClass("select");d.projectSetting.find("#addOrgUser").addClass("tohide");d.projectSetting.find("#teamUserList").addClass("tohide")}else{d.projectSetting.find("#teamUserList").removeClass("tohide");d.projectSetting.find("#user_list").addClass("select");d.projectSetting.find("#addOrgUser").removeClass("tohide");d.initTeam();if(a("#addOrgUser").hasClass("select")){a("#user_list").removeClass("select")}return false}return false}else{d.projectSetting.find("span.boardBackground").hide();f.removeClass("tohide");d.proInfo.addClass("tohide");g.addClass("tohide");d.userOption();return false}}},userOption:function(){var d=this,f=a("#exit_pro_btn",d.projectSetting),h=a("#delete_pro_btn",d.projectSetting),e=a("#suspend_pro_btn",d.projectSetting),g=a("#restart_pro_btn",d.projectSetting),j=a("#finish_pro_btn",d.projectSetting),i=d.projectId.val();j.on("click",function(){layer.confirm("是否要完成该项目",function(k){layer.close(k);a.ajax({type:"post",url:context+"/project/finishPro.htm",data:{proId:i},success:function(l){if(l&&l.success){a("#projectSettingBootstrapLayer").modal("hide");window.location=context+"/project/home.htm";return false}else{layer.msg("请求失败")}},error:function(l){layer.alert("请求失败",1)}})},function(k){layer.close(k)});return false});g.on("click",function(){layer.confirm("是否要重启该项目",function(k){layer.close(k);a.ajax({type:"post",url:context+"/project/restartPro.htm",data:{proId:i},success:function(l){if(l&&l.success){a("#projectSettingBootstrapLayer").modal("hide");window.location=context+"/project/home.htm";return false}else{layer.msg("请求失败")}},error:function(l){layer.alert("请求失败",1)}})},function(k){layer.close(k)});return false});e.on("click",function(){layer.confirm("是否要暂停项目",function(k){layer.close(k);a.ajax({type:"post",url:context+"/project/suspendPro.htm",data:{proId:i},success:function(l){if(l&&l.success){layer.closeAll();a("#projectSettingBootstrapLayer").modal("hide");window.location=context+"/project/home.htm";return false}else{layer.msg("请求失败")}},error:function(l){layer.alert("请求失败",1)}})},function(k){layer.close(k)});return false});f.on("click",function(){layer.confirm("是否要退出该项目",function(k){layer.close(k);a.ajax({type:"post",url:context+"/project/exitPro.htm",data:{proId:i},success:function(l){if(l&&l.success){a("#projectSettingBootstrapLayer").modal("hide");window.location=context+"/project/home.htm";return false}else{if(l&&!l.success){layer.msg(l.errormsg)}else{layer.msg("请求失败")}}},error:function(l){layer.alert("请求失败",1)}})},function(k){layer.close(k)});return false});h.on("click",function(){layer.confirm("是否要删除该项目",function(k){layer.close(k);a.ajax({type:"post",url:context+"/project/deletePro.htm",data:{proId:i},success:function(l){if(l&&l.success){a("#projectSettingBootstrapLayer").modal("hide");window.location=context+"/project/home.htm";return false}else{layer.msg("请求失败")}},error:function(l){layer.alert("请求失败",1)}})},function(k){layer.close(k)});return false})},initTeam:function(){var d=this,e=d.projectId.val();a.ajax({url:context+"/team/proTeamList.htm",type:"post",data:{projectId:e},success:function(f){if(f&&f.success){var g=f.resultData;d.projectSetting.find("#teamUserList").empty();if(g.length<=0){d.projectSetting.find("#teamUserList").append('<div class="team-number team-common  little-portrait corner-3">还没有'+TEXT_CONFIG.tuandui+"</div>");return false}a.each(g,function(h,i){d.projectSetting.find("#teamUserList").append(d.teamUserList(i))})}else{if(f&&!f.success){layer.msg(f.errormsg)}else{layer.msg("请求失败")}}},error:function(f){layer.alert("请求失败",1)}});return false},initUserMana:function(){var d=this,e=d.projectId.val();a.ajax({url:context+"/project/getCode.htm",async:false,type:"post",data:{proId:e},success:function(f){if(f&&f.success){var g=f.resultData;if(g!=""){d.linkBtn.text("关闭链接");d.openLink.show();d.closeLink.hide();d.openLink.attr("value",g)}else{d.linkBtn.text("打开链接");d.openLink.hide();d.closeLink.show()}}else{if(f&&!f.success){layer.msg(f.errormsg)}else{layer.msg("请求失败")}}},error:function(f){layer.alert("请求失败",1)}});return false},usersList:function(){var d=this,e=loginUserInfo.name,f=d.projectId.val();d.teamsList.empty();if(loginUserInfo.name.length>5){e=loginUserInfo.name.substr(0,5)+"..."}a.ajax({url:context+"/project/listProjectUser.htm",type:"post",data:{projectId:f},success:function(g){if(g&&g.success){var h=g.resultData;a.each(h,function(i,j){if(j.userId!=loginUserInfo.userId){d.teamsList.append(d.userList(j))}else{d.teamsList.prepend('<li data-userid = "'+loginUserInfo.userId+'"><img src="'+loginUserInfo.logo+'" class="img-circle headerpic_img" /> <a><span title="'+loginUserInfo.name+'">'+e+'</span><span class="role"></span></a></li>');var k=TEXT_CONFIG.chengyuan;if(j.prjRoleCode=="PRJ_ADMIN"){k="管理员"}else{if(j.prjRoleCode=="PRJ_SUPERVISER"){k="监督员"}}d.teamsList.find('li[data-userid="'+loginUserInfo.userId+'"]').find("span.role").html("我（"+k+"）")}})}else{if(g&&!g.success){layer.msg(g.errormsg)}else{layer.msg("请求失败")}}},error:function(g){layer.alert("请求失败",1)}});return false},teamUserList:function(d){var e=null;e=a('<div class="team-number team-common  little-portrait corner-3" data-teamid= "'+d.teamId+'"/>');if(d.name.length>10){e.append('<i class="icon-trash-empty"></i><h4 title='+d.name+">"+d.name.substring(0,10)+"...</h4>")}else{e.append('<i class="icon-trash-empty"></i><h4 title='+d.name+">"+d.name+"</h4>")}if(d.users==null){}else{a.each(d.users,function(g,h){var f=a('<img title="'+h.name+'" src="'+h.logo+'" class="img-circle">');e.append(f)})}return e},userList:function(h){var d="",f="",i=TEXT_CONFIG.chengyuan,g=h.name;if(h.prjRoleCode=="PRJ_ADMIN"){i="管理员"}if(h.name.length>5){g=h.name.substr(0,5)+"..."}if(h.prjRoleCode=="PRJ_SUPERVISER"){i="监督员"}var e=a('<li data-userid = "'+h.userId+'"><img src="'+h.logo+'" class="img-circle headerpic_img" /> <a><span title="'+h.name+'">'+g+'</span><span class="role">'+i+"</span></a></li>");if(loginUserInfo.userId!=h.userId&&a("#status").text()=="00700"){if(i=="管理员"){e.append('<button class="btn pull-right red-outline outer-borer-red removeUser">移除'+TEXT_CONFIG.chengyuan+'</button><span class="pull-right radio-circle setMember"><i class="icon-record-outline"></i>设为成员</span><span class="pull-right radio-circle setSupervise"><i class=" icon-record-outline"></i>设为监督员</span><span class="pull-right radio-circle setAdmin select"><i class="  icon-dot-circled "></i>设为管理员</span>')}else{if(i=="监督员"){e.append('<button class="btn pull-right red-outline outer-borer-red removeUser">移除'+TEXT_CONFIG.chengyuan+'</button><span class="pull-right radio-circle setMember"><i class="icon-record-outline"></i>设为成员</span><span class="pull-right radio-circle setSupervise select"><i class=" icon-dot-circled "></i>设为监督员</span><span class="pull-right radio-circle setAdmin"><i class="icon-record-outline"></i>设为管理员</span>')}else{e.append('<button class="btn pull-right red-outline outer-borer-red removeUser">移除'+TEXT_CONFIG.chengyuan+'</button><span class="pull-right radio-circle setMember select"><i class="icon-dot-circled"></i>设为成员</span><span class="pull-right radio-circle setSupervise"><i class="icon-record-outline"></i>设为监督员</span><span class="pull-right radio-circle setAdmin"><i class="icon-record-outline"></i>设为管理员</span>')}}}return e},orgProUserMan:function(){var d=this;a(".member-nav",d.projectSetting).on("click","a",function(){if(a(this).hasClass("select")){return false}var e=a(this).siblings("a").removeClass("select").end().addClass("select").data("type");d.hideOrShowUserManaPage(e);return false});a("#userList",d.projectSetting).on("click",".addUserForPro",function(){var f=a(this);var e=a(this).closest("li").data("userid");a.ajax({url:context+"/project/addUserForPro.htm",type:"post",data:{userId:e,proId:d.projectId.val()},success:function(g){f.prop("disabled",false);if(g&&g.success){d.projectSetting.find('li[data-userid="'+e+'"] button').remove();a('<span class="pull-right">已加入'+TEXT_CONFIG.xiangmu+"</span>").appendTo(d.projectSetting.find('li[data-userid="'+e+'"]'))}else{if(g&&!g.success){layer.alert(g.errormsg,1)}else{layer.alert("请求失败",1)}}return false},error:function(g){layer.alert("请求失败",1);f.prop("disabled",false)}});return false});a("#teams",d.projectSetting).on("click",".addTeamForPro",function(){var e=a(this).closest("li").data("teamid");a.ajax({url:context+"/project/addTeamForPro.htm",type:"post",data:{teamId:e,proId:d.projectId.val()},success:function(f){if(f&&f.success){d.projectSetting.find('li[data-teamid="'+e+'"] button').remove();d.projectSetting.find('li[data-teamid="'+e+'"]').append('<span class="pull-right  ">已导入</span>');return false}else{if(f&&!f.success){layer.alert(f.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(f){layer.alert("请求失败",1)}});return false});d.projectSetting.on("click",".addAllUser",function(){a.ajax({url:context+"/project/addAllUserInOrg.htm",type:"post",data:{orgId:d.orgId,proId:d.projectId.val()},success:function(e){if(e&&e.success){d.projectSetting.find("div#orgUserList button").remove();d.projectSetting.find("div#orgUserList").append('<span class="  pull-right  ">已导入</span>')}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(e){layer.alert("请求失败",1)}});return false})},userManBtn:function(){var d=this;d.linkBtn.off("click");d.linkBtn.on("click",function(){if(a(this).text()=="打开链接"){a.ajax({url:context+"/project/encrypt.htm",type:"post",async:false,data:{proId:d.projectId.val(),type:"open"},success:function(e){if(e&&e.success){var f=e.resultData;d.openLink.show();d.closeLink.hide();d.openLink.attr("value",f);d.linkBtn.text("关闭链接")}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(e){layer.alert("请求失败",1)}})}else{a.ajax({url:context+"/project/encrypt.htm",type:"post",async:false,data:{proId:d.projectId.val(),type:"close"},success:function(e){if(e&&e.success){d.openLink.hide();d.closeLink.show();d.linkBtn.text("打开链接")}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(e){layer.alert("请求失败",1)}})}return false});d.email.keydown(function(g){if(g.keyCode==13){var f=a(this).val();a.ajax({url:context+"/project/ToJoinProByEmail.htm",type:"post",data:{proId:d.projectId.val(),account:f},success:function(e){if(e&&e.success){d.email.val("");var h=e.resultData;d.teamsList.append(d.userList(h));return false}else{if(e&&!e.success){layer.alert(e.errormsg);d.email.val("")}else{layer.alert("请求失败",1)}}},error:function(e){layer.alert("请求失败",1)}});return false}});d.teamsList.on("click","button.removeUser",function(){var e=a(this).closest("li").data("userid");a.ajax({url:context+"/project/removeUserByPro.htm",type:"post",data:{proId:d.projectId.val(),userId:e},success:function(f){if(f&&f.success){d.projectSetting.find('li[data-userid="'+e+'"]').remove()}else{if(f&&!f.success){layer.alert(f.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(f){layer.alert("请求失败",1)}});return false});d.teamsList.on("click","span.setAdmin",function(){var g=a(this);var f=g.closest("li").data("userid");var e=d.projectId.val();a.ajax({url:context+"/project/setAdmin.htm",type:"post",data:{userId:f,projectId:e,},success:function(h){if(h&&h.success){var i=g.closest("li");i.children("span").removeClass("select").children().removeClass(" icon-dot-circled ").addClass("icon-record-outline");i.find("span.role").html("管理员");g.addClass("select");g.children().removeClass("icon-record-outline").addClass(" icon-dot-circled ")}else{if(h&&!h.success){layer.alert(h.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(h){layer.alert("请求失败",1)}});return false});d.teamsList.on("click","span.setSupervise",function(){var g=a(this);var f=g.closest("li").data("userid");var e=d.projectId.val();a.ajax({url:context+"/project/setSupervise.htm",type:"post",data:{userId:f,projectId:e,},success:function(h){if(h&&h.success){var i=g.closest("li");i.children("span").removeClass("select").children().removeClass(" icon-dot-circled ").addClass("icon-record-outline");i.find("span.role").html("监督员");g.addClass("select");g.children().removeClass("icon-record-outline").addClass(" icon-dot-circled ")}else{if(h&&!h.success){layer.alert(h.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(h){layer.alert("请求失败",1)}});return false});d.teamsList.on("click","span.setMember",function(){var g=a(this);var f=g.closest("li").data("userid");var e=d.projectId.val();a.ajax({url:context+"/project/setMember.htm",type:"post",data:{userId:f,projectId:e,},success:function(h){if(h&&h.success){var i=g.closest("li");i.children("span").removeClass("select").children().removeClass(" icon-dot-circled ").addClass("icon-record-outline");i.find("span.role").html("成员");g.addClass("select");g.children().removeClass("icon-record-outline").addClass(" icon-dot-circled ")}else{if(h&&!h.success){layer.alert(h.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(h){layer.alert("请求失败",1)}});return false});d.projectSetting.on("click",".icon-trash-empty",function(){var e=a(this).closest("div").data("teamid");a.ajax({url:context+"/project/removeTeamByPro.htm",type:"post",data:{teamId:e,proId:d.projectId.val()},success:function(f){if(f&&f.success){d.projectSetting.find('div[data-teamid="'+e+'"]').remove();var g=d.projectSetting.find("#teamUserList").children(".team-number").length;if(g<=0){d.projectSetting.find("#teamUserList").append('<div class="team-number team-common  little-portrait corner-3">还没有'+TEXT_CONFIG.tuandui+"</div>")}}else{if(f&&!f.success){layer.alert(f.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(f){layer.alert("请求失败",1)}});return false})},hideOrShowUserManaPage:function(g){var e=this;var d=a("#teams_list",e.projectSetting);var f=a("#addOrgList",e.projectSetting);if(g=="userList"){f.hide();d.show();e.initTeam();e.usersList();return false}else{if(g=="addOrgUser"){d.hide();e.addOrgUserList();f.show();return false}}},addOrgUserList:function(){var d=this;a.ajax({url:context+"/project/userOrgList.htm",type:"post",data:{proId:d.projectId.val(),orgId:d.orgId},success:function(e){d.projectSetting.find("#orgUserList").empty();d.projectSetting.find("#orgUserList").append("<em></em>");d.projectSetting.find("#userList").empty();if(e&&e.success){var g=e.resultData;var f=-1;a.each(g,function(h,i){f++});a.each(g,function(h,i){if(i==true||i==false){return false}d.projectSetting.find("#userList").append(d.AllUserList(i))})}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(e){layer.alert("请求失败",1)}});a.ajax({url:context+"/team/teamList.htm",type:"post",data:{orgId:d.orgId,proId:d.projectId.val()},success:function(e){if(e&&e.success){d.projectSetting.find("#teams").empty();var f=e.resultData;a.each(f,function(g,h){d.projectSetting.find("#teams").append(d.teams(h))})}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(e){layer.alert("请求失败",1)}});return false},AllUserList:function(f){var e=f.user.name;if(f.user.name.length>5){e=f.user.name.substr(0,5)+"..."}var d=a('<li data-userid="'+f.user.id+'"><img src="'+f.user.logo+'" class="img-circle" /> <a title="'+f.user.name+'">'+e+" </a></li>");if(f.existPro){d.append('<span class="  pull-right  ">已加入'+TEXT_CONFIG.xiangmu+"</span>")}else{if(a("#status").text()=="00700"){d.append('<button class="btn pull-right outer-borer addUserForPro">加入'+TEXT_CONFIG.xiangmu+"</button> ")}}return d},teams:function(d){var e=null;e=a('<li data-teamid="'+d.team.teamId+'" class="little-portrait"><h4 title='+d.team.name+">"+d.team.name.substring(0,20)+"...</h4> <em></em></li>");if(d.existPro){e.append('<span class="  pull-right  ">已导入</span> ')}else{if(a("#status").text()=="00700"){e.append('<button class="btn pull-right outer-borer addTeamForPro">导入</button>')}}if(d.team.users==null){}else{a.each(d.team.users,function(g,h){var f=a('<img title="'+h.name+'" src="'+h.logo+'" class="img-circle">');e.find("em").append(f)})}return e}};b.init()});