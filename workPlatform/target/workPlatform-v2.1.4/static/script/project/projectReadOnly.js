require(["jquery","script/common/dialogAlert","jqueryForm","layer","my97"],function(a,c){var b;b={init:function(){this.projectSetting=a("#projectSetting");this.navJustified=a(".nav-justified",this.projectSetting);this.panel=a(".main-project");this.proInfo=a("#proInfo",this.projectSetting);this.projectId=this.proInfo.find("#proId");this.linkBtn=a("#link_btn",this.projectSetting);this.closeLink=a("#close_link",this.projectSetting);this.openLink=a("#open_link",this.projectSetting);this.email=a("#add_user_ByEmail",this.projectSetting);this.teamsList=a("#teams_list ul",this.projectSetting);this.orgId=this.projectSetting.find("#orgId").attr("value");this.proInfoValiArray={};this.initProInfo();this.setEvent()},initProInfo:function(){var d=this,i=a("#proLogo",this.projectSetting),h=a("#update_pro_info",this.projectSetting),g=a("#inputLogo",this.projectSetting),e=d.proInfo.find("#proName"),f=d.proInfo.find("#description");if(!d.proInfoValiArray.name){d.proInfoValiArray.name=new InputValidate(e,true,30,0,"text",null)}else{d.proInfoValiArray.name.target.removeClass("error")}if(!d.proInfoValiArray.description){d.proInfoValiArray.description=new InputValidate(f,false,500,0,"",null)}else{elf.proInfoValiArray.description.target.removeClass("error")}i.on("click",function(j){g.click();g.change(function(n){var p=a(this);var m=this.files;if(m.length!=0){var l=m[0],k=new FileReader();if(!k){c.alert("该浏览器不支持头像上传");return}var o=new RegExp("image/(png|jpeg|jpg|gif|img|)","g");if(!o.test(l.type)){c.alert("请选择正确格式的图片");p.after(p.clone(true).val(""));p.remove();return}if(l.limitSize("65","KB")){p.after(p.clone(true).val(""));p.remove();c.alert("图片太大，应65KB以内");return}k.onload=function(q){var r=EventUtil.getTarget(q);i.prop("src",r.result)};k.readAsDataURL(l)}})});d.projectSetting.on("focus","#beginTime",function(){WdatePicker({errDealMode:1,dateFmt:"yyyy年MM月dd日",qsEnabled:false,isShowOK:false,maxDate:d.projectSetting.find("#endTime").val()!=null?d.projectSetting.find("#endTime").val():null,onpicking:function(k){var j=k.cal.getNewDateStr();a(this).val(j);d.projectSetting.find("#input_beginTime").attr("value",j.replace(/(年|月)/g,"-").replace("日",""));d.projectSetting.find("#input_beginTime").val(j.replace(/(年|月)/g,"-").replace("日",""));$dp.hide()},onclearing:function(){a(this).val("");$dp.hide()}});return false});d.projectSetting.on("focus","#endTime",function(){WdatePicker({errDealMode:1,dateFmt:"yyyy年MM月dd日",qsEnabled:false,isShowOK:false,minDate:d.projectSetting.find("#beginTime").val()!=null?d.projectSetting.find("#beginTime").val():null,onpicking:function(k){var j=k.cal.getNewDateStr();a(this).val(j);d.projectSetting.find("#input_endTime").attr("value",j.replace(/(年|月)/g,"-").replace("日",""));d.projectSetting.find("#input_endTime").val(j.replace(/(年|月)/g,"-").replace("日",""));$dp.hide()},onclearing:function(){a(this).val("");$dp.hide()}});return false})},setEvent:function(){var d=this;d.navJustified.on("click","li",function(){if(a(this).hasClass("active")){return false}var e=a(this).siblings("li").removeClass("active").end().addClass("active").data("type");d.hideOrShowSettingPage(e);return})},hideOrShowSettingPage:function(e){var d=this,f=d.projectSetting.find("#advanced-settings"),g=d.projectSetting.find("#add-member");if(e=="projectInfo"){d.proInfo.removeClass("tohide");g.addClass("tohide");f.addClass("tohide");return}else{if(e=="userMan"){d.proInfo.addClass("tohide");f.addClass("tohide");d.initUserMana();d.usersList();g.removeClass("tohide");if(d.orgId==0){d.projectSetting.find("#user_list").removeClass("select");d.projectSetting.find("#addOrgUser").addClass("tohide");d.projectSetting.find("#teamUserList").addClass("tohide")}else{d.projectSetting.find("#teamUserList").removeClass("tohide");d.projectSetting.find("#user_list").addClass("select");d.projectSetting.find("#addOrgUser").removeClass("tohide");d.initTeam();d.orgProUserMan();if(a("#addOrgUser").hasClass("select")){a("#user_list").removeClass("select")}}if(d.projectSetting.find("#status").text()=="00700"){d.userManBtn()}return}else{f.removeClass("tohide");d.proInfo.addClass("tohide");g.addClass("tohide");d.userOption();return}}},userOption:function(){var d=this,e=a("#exit_pro_btn",d.projectSetting),f=d.projectId.val();e.on("click",function(){if(confirm("是否退出该项目")){a.ajax({type:"post",url:context+"/project/exitPro.htm",data:{proId:f},success:function(g){if(g&&g.success){a("#projectSettingBootstrapLayer").modal("hide");window.location=context+"/project/home.htm";return false}else{if(g&&!g.success){layer.msg(g.errormsg)}else{layer.msg("请求失败")}}},error:function(g){}})}return false})},initTeam:function(){var d=this,e=d.projectId.val();a.ajax({url:context+"/team/proTeamList.htm",type:"post",data:{projectId:e},success:function(f){if(f&&f.success){var g=f.resultData;d.projectSetting.find("#teamUserList").empty();if(g.length<=0){d.projectSetting.find("#teamUserList").append('<div class="team-number team-common  little-portrait corner-3">还没有'+TEXT_CONFIG.tuandui+"</div>");return false}a.each(g,function(h,i){d.projectSetting.find("#teamUserList").append(d.teamUserList(i))})}else{if(f&&!f.success){layer.msg(f.errormsg)}else{layer.msg("请求失败")}}}})},initUserMana:function(){var d=this,e=d.projectId.val();a.ajax({url:context+"/project/getCode.htm",type:"post",data:{proId:e},success:function(f){if(f&&f.success){var g=f.resultData;if(g!=""){d.linkBtn.text("关闭链接");d.openLink.show();d.closeLink.hide();d.openLink.attr("value",g)}else{d.linkBtn.text("打开链接");d.openLink.hide();d.closeLink.show()}}else{if(f&&!f.success){layer.msg(f.errormsg)}else{layer.msg("请求失败")}}}})},usersList:function(){var d=this,e=loginUserInfo.name,f=d.projectId.val();d.teamsList.empty();if(loginUserInfo.name.length>5){e=loginUserInfo.name.substr(0,5)+"..."}a.ajax({url:context+"/project/listProjectUser.htm",type:"post",data:{projectId:f},success:function(g){if(g&&g.success){var h=g.resultData;a.each(h,function(i,j){if(j.userId!=loginUserInfo.userId){d.teamsList.append(d.userList(j))}else{d.teamsList.prepend('<li data-userid = "'+loginUserInfo.userId+'"><img src="'+loginUserInfo.logo+'" class="img-circle headerpic_img" /> <a><span title="'+loginUserInfo.name+'">'+e+'</span><span class="role"></span></a></li>');var k=TEXT_CONFIG.chengyuan;if(j.prjRoleCode=="PRJ_ADMIN"){k="管理员"}else{if(j.prjRoleCode=="PRJ_SUPERVISER"){k="监督员"}}d.teamsList.find('li[data-userid="'+loginUserInfo.userId+'"]').find("span.role").html("我（"+k+"）")}})}else{if(g&&!g.success){layer.msg(g.errormsg)}else{layer.msg("请求失败")}}}})},teamUserList:function(d){var e=null;e=a('<div class="team-number team-common  little-portrait corner-3" data-teamid= "'+d.teamId+'"/>');e.append("<h4 title="+d.name+">"+d.name.substring(0,10)+"...("+d.users.length+")</h4>");if(d.users==null){}else{a.each(d.users,function(g,h){var f=a('<img title="'+h.name+'" src="'+h.logo+'" class="img-circle">');e.append(f)})}return e},userList:function(h){var d="",f="",i=TEXT_CONFIG.chengyuan,g=h.name;if(h.prjRoleCode=="PRJ_ADMIN"){d="移除管理员";i="管理员"}else{d="设为管理员"}if(h.name.length>5){g=h.name.substr(0,5)+"..."}if(h.prjRoleCode=="PRJ_SUPERVISER"){f="移除监督员";i="监督员"}else{f="设为监督员"}var e=a('<li data-userid = "'+h.userId+'"><img src="'+h.logo+'" class="img-circle headerpic_img" /> <a><span title="'+h.name+'">'+g+'</span><span class="role">'+i+"</span></a></li>");return e},orgProUserMan:function(){var d=this;a(".member-nav",d.projectSetting).on("click","a",function(){if(a(this).hasClass("select")){return false}var e=a(this).siblings("a").removeClass("select").end().addClass("select").data("type");d.hideOrShowUserManaPage(e)})},hideOrShowUserManaPage:function(g){var e=this;var d=a("#teams_list",e.projectSetting);var f=a("#addOrgList",e.projectSetting);if(g=="userList"){f.hide();d.show();e.initTeam();e.usersList();return}else{if(g=="addOrgUser"){d.hide();e.addOrgUserList();f.show();return}}},addOrgUserList:function(){var d=this;a.ajax({url:context+"/project/userOrgList.htm",type:"post",data:{proId:d.projectId.val(),orgId:d.orgId},success:function(e){d.projectSetting.find("#orgUserList").empty();d.projectSetting.find("#orgUserList").append("<em></em>");d.projectSetting.find("#userList").empty();if(e&&e.success){var g=e.resultData;var f=-1;a.each(g,function(h,i){f++});d.projectSetting.find("#alluser").text("所有"+TEXT_CONFIG.chengyuan+"  . "+f);a.each(g,function(h,i){if(i==true||i==false){return false}d.projectSetting.find("#orgUserList em").append('<img title="'+i.user.name+'" src="'+i.user.logo+'" class="img-circle" />');d.projectSetting.find("#userList").append(d.AllUserList(i))});if(g.allUserExist){d.projectSetting.find("#orgUserList").append('<span class="  pull-right  ">已导入</span>')}}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}}});a.ajax({url:context+"/team/teamList.htm",type:"post",data:{orgId:d.orgId,proId:d.projectId.val()},success:function(e){if(e&&e.success){d.projectSetting.find("#teams").empty();var f=e.resultData;a.each(f,function(g,h){d.projectSetting.find("#teams").append(d.teams(h))})}else{if(e&&!e.success){layer.alert(e.errormsg,1)}else{layer.alert("请求失败",1)}}}})},AllUserList:function(f){var e=f.user.name;if(f.user.name.length>5){e=f.user.name.substr(0,5)+"..."}var d=a('<li data-userid="'+f.user.id+'"><img src="'+f.user.logo+'" class="img-circle" /> <a title="'+f.user.name+'">'+e+" </a></li>");if(f.existPro){d.append('<span class="  pull-right  ">已加入'+TEXT_CONFIG.xiangmu+"</span>")}return d},teams:function(d){var e=null;e=a('<li data-teamid="'+d.team.teamId+'" class="little-portrait"><h4>'+d.team.name+" . "+d.team.users.length+"</h4> <em></em></li>");if(d.existPro){e.append('<span class="  pull-right  ">已导入</span> ')}if(d.team.users==null){}else{a.each(d.team.users,function(g,h){var f=a('<img title="'+h.name+'" src="'+h.logo+'" class="img-circle">');e.find("em").append(f)})}return e}};b.init()});