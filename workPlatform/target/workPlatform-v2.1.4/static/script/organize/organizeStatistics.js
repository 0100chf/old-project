require(["jquery","highcharts"],function(){var a=$("div[data-id='organizationTemplate']");var b={init:function(){var c=1;this.staffTaskStatisticsChart=a.find("#staffTaskStatisticsChart");this.projectTaskStatisticsChart=a.find("#projectTaskStatisticsChart");this.teamTaskStatisticsChart=a.find("#teamTaskStatisticsChart");this.staffWTimeStatisticsChart=a.find("#staffWTimeStatisticsChart");this.projectWTimeStatisticsChart=a.find("#projectWTimeStatisticsChart");this.teamWTimeStatisticsChart=a.find("#teamWTimeStatisticsChart");this.color=["#058DC7","#99CC66","#CCFF66","#FF0000"];this.typeName=["总数","已完成","未完成","逾期"];this.typeNameByTime=["计划工时","实际工时"];this.setTaskEvent();this.setWorktimeEvent();this.getUserStatisticsDataByTask(c,true);this.getUserStatisticsDataByTime(c,true);a.find("#staffStatisticsMenu span").data("value",c);a.find("#staffWorkStatisticsMenu span").data("value",c)},setTaskEvent:function(){var c=this;a.find("#userStatistics ").on("click","li",function(){var e=$(this);if(e.hasClass("active")){return false}var d=a.find("#staffStatisticsMenu span").data("value");e.siblings("li").removeClass("active").end().addClass("active");if(e.data("type")=="user"){c.staffTaskStatisticsChart.show();c.projectTaskStatisticsChart.hide();c.teamTaskStatisticsChart.hide();c.getUserStatisticsDataByTask(d,true);return false}else{if(e.data("type")=="project"){c.staffTaskStatisticsChart.hide();c.projectTaskStatisticsChart.show();c.teamTaskStatisticsChart.hide();c.getProjectStatisticsData(d,true);return false}else{if(e.data("type")=="team"){c.staffTaskStatisticsChart.hide();c.projectTaskStatisticsChart.hide();c.teamTaskStatisticsChart.show();c.getTeamStatisticsData(d,true);return false}}}});a.on("click","#staffStatisticsMenu",function(){$(this).find("ul li:eq('"+$(this).find("span").data("value")+"')").find(".icon-ok").show();$(this).find("ul").show();return false});a.on("click","#staffStatisticsMenu li",function(){if($(this).index()==a.find("#staffStatisticsMenu span").data("value")){$(this).closest("ul").hide();return false}var d=a.find("#userStatistics li.active").data("type"),e=$(this).index();if(d=="user"){c.getUserStatisticsDataByTask(e,false)}else{if(d=="project"){c.getProjectStatisticsData(e,false)}else{if(d=="team"){c.getTeamStatisticsData(e,false)}}}a.find("#staffStatisticsMenu span").text($(this).text()).data("value",$(this).index());$(this).siblings().find(".icon-ok").hide();$(this).closest("ul").hide();return false});$(document).on("click",function(d){a.find("#staffStatisticsMenu").find("ul").hide()});a.on("click","#xmTjExport",function(){var e=a.find("#staffStatisticsMenu span").data("value");var d=a.find("#userStatistics li.active").data("type");if(d=="user"){c.exportUsersTongJi(e)}else{if(d=="project"){c.exportProjectsTongJi(e)}else{if(d=="team"){c.exportTeamTongJi(e)}}}return})},setWorktimeEvent:function(){var c=this;a.find("#wTimeStatistics").on("click"," li",function(){var e=$(this);if(e.hasClass("active")){return false}var d=a.find("#staffWorkStatisticsMenu span").data("value");e.siblings("li").removeClass("active").end().addClass("active");if(e.data("type")=="user"){c.staffWTimeStatisticsChart.show();c.projectWTimeStatisticsChart.hide();c.teamWTimeStatisticsChart.hide();c.getUserStatisticsDataByTime(d,true);return false}else{if(e.data("type")=="project"){c.staffWTimeStatisticsChart.hide();c.projectWTimeStatisticsChart.show();c.teamWTimeStatisticsChart.hide();c.getProjectStatisticsDataByTime(d,true);return false}else{if(e.data("type")=="team"){c.staffWTimeStatisticsChart.hide();c.projectWTimeStatisticsChart.hide();c.teamWTimeStatisticsChart.show();c.getTeamStatisticsDataByTime(d,true);return false}}}});a.on("click","#staffWorkStatisticsMenu",function(){$(this).find("ul li:eq('"+$(this).find("span").data("value")+"')").find(".icon-ok").show();$(this).find("ul").show();return false});a.on("click","#staffWorkStatisticsMenu li",function(){if($(this).text()==a.find("#staffWorkStatisticsMenu span").text()){$(this).closest("ul").hide();return false}var d=a.find("#wTimeStatistics li.active").data("type"),e=$(this).index();if(d=="user"){c.getUserStatisticsDataByTime(e,false)}else{if(d=="project"){c.getProjectStatisticsDataByTime(e,false)}else{if(d=="team"){c.getTeamStatisticsDataByTime(e,false)}}}a.find("#staffWorkStatisticsMenu span").text($(this).text()).data("value",$(this).index());$(this).siblings().find(".icon-ok").hide();$(this).closest("ul").hide();return false});$(document).on("click",function(d){a.find("#staffWorkStatisticsMenu").find("ul").hide()});a.on("click","#xmTjExportByTime",function(){var e=a.find("#staffWorkStatisticsMenu span").data("value");var d=a.find("#wTimeStatistics li.active").data("type");if(d=="user"){c.exportUsersTongJiByTime(e)}else{if(d=="project"){c.exportProjectsTongJiByTime(e)}else{if(d=="team"){c.exportTeamTongJiByTime(e)}}}return})},exportUsersTongJi:function(d){var c=a.data("organizationid");window.location.href=context+"/org/exportOrganizationStatistics_user.htm?orgId="+c+"&type="+d},exportProjectsTongJi:function(d){var c=a.data("organizationid");window.location.href=context+"/org/exportOrganizationStatistics_project.htm?orgId="+c+"&type="+d},exportTeamTongJi:function(d){var c=a.data("organizationid");window.location.href=context+"/org/exportOrganizationStatistics_team_task.htm?orgId="+c+"&type="+d},exportUsersTongJiByTime:function(d){var c=a.data("organizationid");window.location.href=context+"/org/exportOrganizationStatistics_user_time.htm?orgId="+c+"&type="+d},exportProjectsTongJiByTime:function(d){var c=a.data("organizationid");window.location.href=context+"/org/exportOrganizationStatistics_project_time.htm?orgId="+c+"&type="+d},exportTeamTongJiByTime:function(d){var c=a.data("organizationid");window.location.href=context+"/org/exportOrganizationStatistics_team_time.htm?orgId="+c+"&type="+d},getUserStatisticsDataByTask:function(d,e){var c=this;$.ajax({url:context+"/org/findOrganizationStatistics_user.htm",data:{orgId:a.data("organizationid"),loadType:d},type:"post"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;if(e){var f=(h.length*100+120)+"px";a.find("#staffTaskStatisticsChart").css({"min-width":"400px","max-width":"400px",height:f,"margin-top":"20px"});c.setUserStatisticsChartByTask(h)}else{c.refreshUserStatisticsChart(h)}}else{layer.msg(g.errormsg)}}).fail(function(f){layer.msg("请求失败")})},refreshUserStatisticsChart:function(d){var c=this.dataAssembledByTask(d);this.userStatisticsChart.series[0].setData(c.overdue);this.userStatisticsChart.series[1].setData(c.noDone);this.userStatisticsChart.series[2].setData(c.over);this.userStatisticsChart.series[3].setData(c.all)},dataAssembledByTask:function(g){var i={};var d=[];var h=[];var e=[];var f=[];var c=[];$.each(g,function(j,l){var k=l.taskCount-l.noTaskCount;d.push(l.taskCount);h.push(k<0?0:k);e.push(l.noTaskCount);f.push(l.tardyTaskCount);c.push(l.name)});i.all=d;i.over=h;i.noDone=e;i.overdue=f;i.name=c;return i},dataAssembledByTime:function(e){var g={};var f=[];var d=[];var c=[];$.each(e,function(h,i){f.push(i.planDay);d.push(i.realityDay);c.push(i.name)});g.planDay=f;g.realityDay=d;g.name=c;return g},setUserStatisticsChartByTask:function(e){var c=this;var d=c.dataAssembledByTask(e);this.userStatisticsChart=new Highcharts.Chart({chart:{renderTo:"staffTaskStatisticsChart",type:"bar"},title:{text:""},xAxis:{categories:d.name,title:{text:null},labels:{overflow:"justify",formatter:function(){var f=this.value;return c.getStrActualLen(f,8)}}},yAxis:{min:0,title:{text:"任务个数",align:"high"},labels:{overflow:"justify"},allowDecimals:false},tooltip:{shared:true,formatter:function(){var g="";var f=this.points[3].y;g+="<b>"+this.x+": ";if(f>0){g+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[3].series.name+": "+this.points[3].y;g+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[2].series.name+": "+this.points[2].y+"个,占"+parseInt(this.points[2].y/f*100)+"%";g+='<br/><tspan style="fill:'+c.color[2]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y+"个,占"+(100-parseInt((f-this.points[1].y)/f*100))+"%";g+='<br/><tspan style="fill:'+c.color[3]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y+"个,占"+parseInt(this.points[0].y/f*100)+"%"}else{g+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[3].series.name+": "+this.points[3].y;g+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[2].series.name+": "+this.points[2].y;g+='<br/><tspan style="fill:'+c.color[2]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y;g+='<br/><tspan style="fill:'+c.color[3]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y}return g}},plotOptions:{bar:{dataLabels:{enabled:true},pointWidth:13,borderWidth:0},column:{stacking:"normal"}},credits:{enabled:false},series:[{name:c.typeName[3],data:d.overdue,color:c.color[3]},{name:c.typeName[2],data:d.noDone,color:c.color[2]},{name:c.typeName[1],data:d.over,color:c.color[1]},{name:c.typeName[0],data:d.all,color:c.color[0]}]})},getProjectStatisticsData:function(d,e){var c=this;$.ajax({url:context+"/org/findOrganizationStatistics_project.htm",data:{orgId:a.data("organizationid"),loadType:d},type:"post"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;if(e){var f=(h.length*100+120)+"px";a.find("#projectTaskStatisticsChart").css({"min-width":"400px","max-width":"400px",height:f,"margin-top":"20px"});c.setProjectStatisticsChart(h)}else{c.refreshProjectStatisticsChartByTask(h)}}else{layer.msg(g.errormsg)}}).fail(function(f){layer.msg("请求失败")})},getTeamStatisticsData:function(d,e){var c=this;$.ajax({url:context+"/org/findOrganizationStatistics_team.htm",data:{orgId:a.data("organizationid"),loadType:d},type:"post"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;if(e){var f=(h.length*100+120)+"px";a.find("#teamTaskStatisticsChart").css({"min-width":"400px","max-width":"400px",height:f,"margin-top":"20px"});c.setTeamStatisticsChart(h)}else{c.refreshTeamStatisticsChartByTask(h)}}else{layer.msg(g.errormsg)}}).fail(function(f){layer.msg("请求失败")})},setProjectStatisticsChart:function(e){var c=this;var d=c.dataAssembledByTask(e);this.projectStatisticsChart=new Highcharts.Chart({chart:{renderTo:"projectTaskStatisticsChart",type:"bar"},title:{text:""},xAxis:{categories:d.name,title:{text:null},labels:{overflow:"justify",formatter:function(){var f=this.value;return c.getStrActualLen(f,8)}}},yAxis:{min:0,title:{text:"任务个数",align:"high"},labels:{overflow:"justify"},allowDecimals:false},tooltip:{shared:true,formatter:function(){var g="";var f=this.points[3].y;g+="<b>"+this.x+": ";if(f>0){g+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[3].series.name+": "+this.points[3].y;g+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[2].series.name+": "+this.points[2].y+"个,占"+parseInt(this.points[2].y/f*100)+"%";g+='<br/><tspan style="fill:'+c.color[2]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y+"个,占"+(100-parseInt((f-this.points[1].y)/f*100))+"%";g+='<br/><tspan style="fill:'+c.color[3]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y+"个,占"+parseInt(this.points[0].y/f*100)+"%"}else{g+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[3].series.name+": "+this.points[3].y;g+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[2].series.name+": "+this.points[2].y;g+='<br/><tspan style="fill:'+c.color[2]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y;g+='<br/><tspan style="fill:'+c.color[3]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y}return g}},plotOptions:{bar:{dataLabels:{enabled:true},pointWidth:13,borderWidth:0},column:{stacking:"normal"}},credits:{enabled:false},series:[{name:c.typeName[3],data:d.overdue,color:c.color[3]},{name:c.typeName[2],data:d.noDone,color:c.color[2]},{name:c.typeName[1],data:d.over,color:c.color[1]},{name:c.typeName[0],data:d.all,color:c.color[0]}]})},setTeamStatisticsChart:function(e){var c=this;var d=c.dataAssembledByTask(e);this.teamStatisticsChart=new Highcharts.Chart({chart:{renderTo:"teamTaskStatisticsChart",type:"bar"},title:{text:""},xAxis:{categories:d.name,title:{text:null},labels:{overflow:"justify",formatter:function(){var f=this.value;return c.getStrActualLen(f,8)}}},yAxis:{min:0,title:{text:"任务个数",align:"high"},labels:{overflow:"justify"},allowDecimals:false},tooltip:{shared:true,formatter:function(){var g="";var f=this.points[3].y;g+="<b>"+this.x+": ";if(f>0){g+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[3].series.name+": "+this.points[3].y;g+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[2].series.name+": "+this.points[2].y+"个,占"+parseInt(this.points[2].y/f*100)+"%";g+='<br/><tspan style="fill:'+c.color[2]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y+"个,占"+(100-parseInt((f-this.points[1].y)/f*100))+"%";g+='<br/><tspan style="fill:'+c.color[3]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y+"个,占"+parseInt(this.points[0].y/f*100)+"%"}else{g+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[3].series.name+": "+this.points[3].y;g+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[2].series.name+": "+this.points[2].y;g+='<br/><tspan style="fill:'+c.color[2]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y;g+='<br/><tspan style="fill:'+c.color[3]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y}return g}},plotOptions:{bar:{dataLabels:{enabled:true},pointWidth:13,borderWidth:0},column:{stacking:"normal"}},credits:{enabled:false},series:[{name:c.typeName[3],data:d.overdue,color:c.color[3]},{name:c.typeName[2],data:d.noDone,color:c.color[2]},{name:c.typeName[1],data:d.over,color:c.color[1]},{name:c.typeName[0],data:d.all,color:c.color[0]}]})},getStrActualLen:function(f,c){var e="";if(f==null||f.length==0){return""}if(f.replace(/[^\x00-\xff]/g,"xx").length>c){for(var d=0;e.replace(/[^\x00-\xff]/g,"xx").length<c;d++){e=f.substring(0,d)}e=e+"..."}else{e=f}return e},getUserStatisticsDataByTime:function(d,e){var c=this;$.ajax({url:context+"/org/findOrganizationTimeStatistics_user.htm",data:{orgId:a.data("organizationid"),loadType:d},type:"post"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;if(e){var f=(h.length*100+120)+"px";a.find("#staffWTimeStatisticsChart").css({"min-width":"400px","max-width":"400px",height:f,"margin-top":"20px"});c.setUserStatisticsChartByTime(h)}else{c.refreshUserStatisticsChartByTime(h)}}else{layer.msg(g.errormsg)}}).fail(function(f){layer.msg("请求失败")})},setUserStatisticsChartByTime:function(e){var c=this;var d=c.dataAssembledByTime(e);this.userStatisticsChartByTime=new Highcharts.Chart({chart:{renderTo:"staffWTimeStatisticsChart",type:"bar"},title:{text:""},xAxis:{categories:d.name,title:{text:null},labels:{overflow:"justify",formatter:function(){var f=this.value;return c.getStrActualLen(f,8)}}},yAxis:{min:0,title:{text:"工时",align:"high"},labels:{overflow:"justify"},allowDecimals:false},tooltip:{shared:true,formatter:function(){var f="";f+="<b>"+this.x+": ";f+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y+"天";f+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y+"天";return f}},plotOptions:{bar:{dataLabels:{enabled:true},pointWidth:13,borderWidth:0},column:{stacking:"normal"}},credits:{enabled:false},series:[{name:c.typeNameByTime[0],data:d.planDay,color:c.color[0]},{name:c.typeNameByTime[1],data:d.realityDay,color:c.color[1]}]})},getProjectStatisticsDataByTime:function(d,e){var c=this;$.ajax({url:context+"/org/findOrganizationTimeStatistics_project.htm",data:{orgId:a.data("organizationid"),loadType:d},type:"post"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;if(e){var f=(h.length*100+120)+"px";a.find("#projectWTimeStatisticsChart").css({"min-width":"400px","max-width":"400px",height:f,"margin-top":"20px"});c.setProjectStatisticsChartByTime(h)}else{c.refreshProjectStatisticsChartByTime(h)}}else{layer.msg(g.errormsg)}}).fail(function(f){layer.msg("请求失败")})},setProjectStatisticsChartByTime:function(e){var c=this;var d=c.dataAssembledByTime(e);this.projectStatisticsChartByTime=new Highcharts.Chart({chart:{renderTo:"projectWTimeStatisticsChart",type:"bar"},title:{text:""},xAxis:{categories:d.name,title:{text:null},labels:{overflow:"justify",formatter:function(){var f=this.value;return c.getStrActualLen(f,8)}}},yAxis:{min:0,title:{text:"工时（天）",align:"high"},labels:{overflow:"justify"},allowDecimals:false},tooltip:{shared:true,formatter:function(){var f="";f+="<b>"+this.x+": ";f+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y+"天";f+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y+"天";return f}},plotOptions:{bar:{dataLabels:{enabled:true},pointWidth:13,borderWidth:0},column:{stacking:"normal"}},credits:{enabled:false},series:[{name:c.typeNameByTime[0],data:d.planDay,color:c.color[0]},{name:c.typeNameByTime[1],data:d.realityDay,color:c.color[1]}]})},getTeamStatisticsDataByTime:function(d,e){var c=this;$.ajax({url:context+"/org/findOrganizationTimeStatistics_team.htm",data:{orgId:a.data("organizationid"),loadType:d},type:"post"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;if(e){var f=(h.length*100+120)+"px";a.find("#teamWTimeStatisticsChart").css({"min-width":"400px","max-width":"400px",height:f,"margin-top":"20px"});c.setTeamStatisticsChartByTime(h);return false}else{c.refreshTeamStatisticsChartByTime(h)}}else{layer.msg(g.errormsg)}}).fail(function(f){layer.msg("请求失败")})},setTeamStatisticsChartByTime:function(e){var c=this;var d=c.dataAssembledByTime(e);this.teamStatisticsChartByTime=new Highcharts.Chart({chart:{renderTo:"teamWTimeStatisticsChart",type:"bar"},title:{text:""},xAxis:{categories:d.name,title:{text:null},labels:{overflow:"justify",formatter:function(){var f=this.value;return c.getStrActualLen(f,8)}}},yAxis:{min:0,title:{text:"工时（天）",align:"high"},labels:{overflow:"justify"},allowDecimals:false},tooltip:{shared:true,formatter:function(){var f="";f+="<b>"+this.x+": ";f+='<br/><tspan style="fill:'+c.color[0]+'" x="8" dy="16">●</tspan>'+this.points[0].series.name+": "+this.points[0].y+"天";f+='<br/><tspan style="fill:'+c.color[1]+'" x="8" dy="16">●</tspan>'+this.points[1].series.name+": "+this.points[1].y+"天";return f}},plotOptions:{bar:{dataLabels:{enabled:true},pointWidth:13,borderWidth:0},column:{stacking:"normal"}},credits:{enabled:false},series:[{name:c.typeNameByTime[0],data:d.planDay,color:c.color[0]},{name:c.typeNameByTime[1],data:d.realityDay,color:c.color[1]}]})},refreshUserStatisticsChartByTime:function(d){var c=this.dataAssembledByTime(d);this.userStatisticsChartByTime.series[0].setData(c.planDay);this.userStatisticsChartByTime.series[1].setData(c.realityDay)},refreshProjectStatisticsChartByTask:function(d){var c=this.dataAssembledByTask(d);this.projectStatisticsChart.series[0].setData(c.overdue);this.projectStatisticsChart.series[1].setData(c.noDone);this.projectStatisticsChart.series[2].setData(c.over);this.projectStatisticsChart.series[3].setData(c.all)},refreshTeamStatisticsChartByTask:function(d){var c=this.dataAssembledByTask(d);this.teamStatisticsChart.series[0].setData(c.overdue);this.teamStatisticsChart.series[1].setData(c.noDone);this.teamStatisticsChart.series[2].setData(c.over);this.teamStatisticsChart.series[3].setData(c.all)},refreshProjectStatisticsChartByTime:function(d){var c=this.dataAssembledByTime(d);this.projectStatisticsChartByTime.series[0].setData(c.planDay);this.projectStatisticsChartByTime.series[1].setData(c.realityDay)},refreshTeamStatisticsChartByTime:function(d){var c=this.dataAssembledByTime(d);this.teamStatisticsChartByTime.series[0].setData(c.planDay);this.teamStatisticsChartByTime.series[1].setData(c.realityDay)},};b.init()});