require(["script/common/personList","jquery","layer"],function(b){var a={init:function(){this.panel=$("#dynamic_view");this.projectId=this.panel.closest("div[data-id='projectTemplate']").data("projectId");this.users=window.projectUserList;this.initView();this.setEvent()},setEvent:function(){var c=this;var d=c.panel.find("#selectWeek");c.panel.on("click","#selected",function(){d.show();var e=$(this).data("time");d.find("li").each(function(){if($(this).data("time")==e){$(this).find("i").show()}else{$(this).find("i").hide()}});return false});d.on("click","li",function(g){var e=c.panel.find("#selected");d.find("i").hide();$(this).find("i").show();e.data("time",$(this).data("time"));e.html($(this).text()+'<i class=" icon-down-dir"></i>');d.hide();var h=e.data("time").split("~");var i="",f="";c.panel.find(".check-box").each(function(){if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){i+=$(this).closest("li").data("userid")+","}});c.panel.find("#dynamicType li").each(function(){if($(this).find("span").children("i").length>0){f+=$(this).data("type")+","}});if(f.length>0){f=f.substring(0,f.length-1)}if(i.length>0){i=i.substring(0,i.length-1)}$.ajax({type:"post",data:{monday:h[0],sunday:h[1],userIds:i,projectId:c.projectId,types:f},url:context+"/dynamic/findProjectDynamic.htm"}).done(function(j){if(j&&j.success&&j.resultData){var k=j.resultData;c.panel.find("#dynamic_content").empty();if(k){$.each(k,function(l,m){c.panel.find("#dynamic_content").append(c.initProjectDynamic(l,m))})}c.addPicture();return}else{if(j&&!j.success){layer.msg(j.errormsg)}else{layer.msg("请求失败")}}})});c.panel.find("#userList .check-box").on("click",function(){var f=$(this).closest("li").data("userid");var h=c.panel.find("#selected").data("time").split("~"),e="";c.panel.find("#dynamicType li").each(function(){if($(this).find("span").children("i").length>0){e+=$(this).data("type")+","}});if(e.length>0){e=e.substring(0,e.length-1)}if(f<=0){if($(this).children("i").length<=0){var i="";c.panel.find("#userList .check-box").each(function(){if($(this).children("i").length<=0){$(this).append('<i class="icon-ok"></i>')}if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){i+=$(this).closest("li").data("userid")+","}});i=i.substring(0,i.length-1);$.ajax({type:"post",url:context+"/dynamic/findProjectDynamic.htm",data:{userIds:i,projectId:c.projectId,monday:h[0],sunday:h[1],types:e},success:function(j){if(j&&j.success&&j.resultData){var k=j.resultData;c.panel.find("#dynamic_content").empty();if(k){$.each(k,function(l,m){c.panel.find("#dynamic_content").append(c.initProjectDynamic(l,m))})}c.addPicture();return false}}})}else{c.panel.find("#userList .check-box").each(function(){$(this).find("i").remove()});c.panel.find("#dynamic_content").empty()}}else{if($(this).children("i").length<=0){$(this).append('<i class="icon-ok"></i>');var i="";var g=true;$(".check-box").each(function(){if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){i+=$(this).closest("li").data("userid")+","}if($(this).children("i").length<=0&&$(this).closest("li").data("userid")>0){g=false}});i=i.substring(0,i.length-1);if(g){c.panel.find("#allUser").append('<i class="icon-ok"></i>')}$.ajax({type:"post",url:context+"/dynamic/findProjectDynamic.htm",data:{userIds:i,projectId:c.projectId,monday:h[0],sunday:h[1],types:e},success:function(j){if(j&&j.success&&j.resultData){var k=j.resultData;if(k){c.panel.find("#dynamic_content").empty();$.each(k,function(l,m){c.panel.find("#dynamic_content").append(c.initProjectDynamic(l,m))});c.addPicture();return}}}})}else{$(this).find("i").remove();if(c.panel.find("#allUser").children("i").length>0){c.panel.find("#allUser").empty()}c.panel.find('div[data-userid="'+f+'"]').remove();c.panel.find("#dynamic_content .time-block").each(function(){if($(this).children("div.list-block").length<=0){$(this).closest("ul").remove()}})}}c.addPicture()});c.panel.find("#dynamicType").on("click",".check-box",function(){var f=c.panel.find("#selected").data("time").split("~");var h=$(this).closest("li").text();var e="",g="";if($(this).children("i").length<=0){$(this).append('<i class="icon-ok"></i>');c.panel.find("#dynamicType li").each(function(){if($(this).find("span").children("i").length>0){e+=$(this).data("type")+","}});$("#userList .check-box").each(function(){if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){g+=$(this).closest("li").data("userid")+","}});if(e.length>0){e=e.substring(0,e.length-1)}if(g.length>0){g=g.substring(0,g.length-1)}$.ajax({type:"post",url:context+"/dynamic/findProjectDynamic.htm",data:{userIds:g,projectId:c.projectId,monday:f[0],sunday:f[1],types:e},success:function(i){if(i&&i.success&&i.resultData){var j=i.resultData;if(j){c.panel.find("#dynamic_content").empty();$.each(j,function(k,l){c.panel.find("#dynamic_content").append(c.initProjectDynamic(k,l))})}c.addPicture();return}}})}else{$(this).find("i").remove();c.panel.find("#dynamic_content div.list-block").each(function(){if($(this).find(".task-content").text()==h){$(this).remove()}});c.panel.find("#dynamic_content .time-block").each(function(){if($(this).children("div.list-block").length<=0){$(this).closest("ul").remove()}})}c.addPicture()})},initView:function(){var c=this,e="",d="";var f=c.users;c.panel.find("#userList").empty();c.panel.on("click",function(){c.panel.find("#selectWeek").hide()});c.panel.find("#userList").append('<li data-userid="0"><span class="check-box" id="allUser"><i class="icon-ok"></i></span> <img class="img-circle" src="'+context+'/static/images/head-portraits2.png" /><a>所有'+TEXT_CONFIG.chengyuan+"</a></li>");$.each(f,function(h,g){var i=g.name;if(i.length>5){i=i.substr(0,5)+"..."}c.panel.find("#userList").append('<li data-userid = "'+g.userId+'"><span class="check-box"><i class="icon-ok"></i></span>  <img class="img-circle" src="'+g.logo+'" /><a title="'+g.name+'">'+i+"</a></li>")});c.panel.find("#userList li").each(function(){if($(this).find("span").children("i").length>0&&$(this).data("userid")>0){e+=$(this).data("userid")+","}});c.panel.find("#dynamicType li").each(function(){if($(this).find("span").children("i").length>0){d+=$(this).data("type")+","}});if(e.length>0){e=e.substring(0,e.length-1)}if(d.length>0){d=d.substring(0,d.length-1)}$.ajax({type:"post",url:context+"/dynamic/initProjectDynamic.htm",data:{userIds:e,projectId:c.projectId,types:d},success:function(g){if(g&&g.success&&g.resultData){var j=g.resultData;var h=0;if(j&&j.dataList&&j.dataList.length>0){c.panel.find("#selectWeek").empty();$.each(j.dataList,function(m,p){var q=new Date(),l=q.getFullYear();var n=new RegExp(l+".","g");var o=new RegExp(l-1+".","g");var i=p.replace(n,"").replace(o,"");h++;if(h==1){c.panel.find("#selected_time").append('<a id="selected" data-time = "'+p+'">'+i+'<i class=" icon-down-dir"></i></a>')}var k=$('<li data-time="'+p+'"><a>'+i+'</a><i class=" icon-ok"></i></li>');c.panel.find("#selectWeek").append(k)})}if(j&&j.pActionRecord&&j.pActionRecord!=null){c.panel.find("#dynamic_content").empty();$.each(j.pActionRecord,function(i,k){c.panel.find("#dynamic_content").append(c.initProjectDynamic(i,k))})}c.addPicture();return}}});c.addPicture()},initProjectDynamic:function(l,k){var m=this;var j=new Date(Date.parse(l.replace(/-/g,"/")));var h=j.toLocaleDateString();var g=new Date();var f=g.toLocaleDateString();var i=g.getFullYear();l=l.replace(i+".","");if(h==f){l="今天"}var e=$('<ul><li><span class="time">'+l+'</span></li><li><a class="select"><i class="icon-calendar"></i> <span class="left-dynamic-arrow"></span></a></li><li class="size-auto"><div class="time-block corner-3 dynamicInfo"></div></li> </ul>');if(k.length>0){$.each(k,function(n,q){var o="";if((q.useage<="00618"&&q.useage>="00600")||(q.useage>="00651"&&q.useage<="00653")||(q.useage>="00654"&&q.useage<="00661")){o="任务"}else{if(q.useage<="00622"&&q.useage>="00619"){o="文件库"}else{if(q.useage=="00623"||q.useage=="00624"||q.useage=="00642"||q.useage=="00643"){o="会议"}else{if(q.useage<="00626"&&q.useage>="00625"){o="周报"}else{if((q.useage<="00641"&&q.useage>="00627")||(q.useage>="00644"&&q.useage<="00650")){o=TEXT_CONFIG.xiangmu+"设置"}}}}}var p="",r=q.userName,c=q.record;$.each(m.users,function(s,t){if(t.userId==q.userId){p=t.logo}});if(r.length>5){r=r.substr(0,5)+"..."}if(c.length>30){c=c.substr(0,30)+"..."}var d=$('<div class="list-block" data-userid="'+q.userId+'"><p class="user"><img src="'+p+'" class=" img-circle"><span title="'+q.userName+'">'+r+'</span><span title="'+q.record+'">'+c+'</span></p><p class="task-content"><i class="icon-tasks"></i>'+o+"</p><time>"+q.createdTimeString+"</time></div>");e.find(".dynamicInfo").append(d)})}return e},addPicture:function(){var c=this;if(c.panel.find("#dynamic_content").children("ul").length==0){c.panel.find("div#dynamic_content").html('<div class="none-content-project" style="margin-top:60px;"><em class="icon-back-in-time"></em><br /><p>目前还没有动态</p></div> ')}}};a.init()});