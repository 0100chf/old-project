require(["script/common/personList",context+"/static/script/weeklyReport/proWeeklyReport.js?_T="+(new Date()).valueOf(),"jquery","layer"],function(b,c){var a={init:function(){this.panel=$("#proUserWeekRep");this.projectId=this.panel.closest("div[data-id='projectTemplate']").data("projectId");this.viewInit();this.setEvent();c.btnClick()},setEvent:function(){var d=this;d.panel.on("click",function(){d.panel.find("ul#selectWeek").hide()});d.panel.find(".check-box").on("click",function(){var g=$(this).closest("li").data("userid");var f=d.panel.find("#selected").data("time").split("~");if(g<=0){if($(this).children("i").length<=0){var i="";d.panel.find(".check-box").each(function(){if($(this).children("i").length<=0){$(this).append('<i class="icon-ok"></i>')}if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){i+=$(this).closest("li").data("userid")+","}});i=i.substring(0,i.length-1);$.ajax({type:"post",url:context+"/weeklyReport/findUsersWReportByProId.htm",data:{userIds:i,projectId:d.projectId,monday:f[0]},success:function(j){if(j&&j.success&&j.resultData){var l=j.resultData;d.panel.find("#proUserWReport").empty();var k=window.readOnly?"":'<i class="icon-arrows-ccw createUserWeekLyReport"></i>';$.each(window.projectUserList,function(o,n){var m='<ul data-userid = "'+n.userId+'"><li><span class="time">'+n.name+'</span></li><li><a  class="weekly-header"> <img class="img-circle" src="'+n.logo+'"/><span class="left-arrow"></span></a></li> <li class="size-auto"> <div class="time-block corner-3"><div class="weekly-project"><p>系统未生成该'+TEXT_CONFIG.chengyuan+"周报"+k+"</p></div></div></li>";d.panel.find("#proUserWReport").append(m)});if(l){$.each(l,function(m,n){d.panel.find('#proUserWReport ul[data-userid="'+n.user.userId+'"]').data("userweekrepid",n.userWeekReportId);d.panel.find('#proUserWReport ul[data-userid="'+n.user.userId+'"]').find(".weekly-project").html(d.proUserWReportInfo(n))})}}}})}else{d.panel.find(".check-box").each(function(){$(this).find("i").remove()});d.panel.find("#proUserWReport").empty()}}else{if($(this).children("i").length<=0){$(this).append('<i class="icon-ok"></i>');var i="";var h=true;d.panel.find(".check-box").each(function(){if($(this).children("i").length>0){i+=$(this).closest("li").data("userid")+","}if($(this).children("i").length<=0&&$(this).closest("li").data("userid")>0){h=false}});i=i.substring(0,i.length-1);if(h){d.panel.find("#allUser").append('<i class="icon-ok"></i>')}$.ajax({type:"post",url:context+"/weeklyReport/findUsersWReportByProId.htm",data:{userIds:i,projectId:d.projectId,monday:f[0]},success:function(j){if(j&&j.success&&j.resultData){var l=j.resultData;d.panel.find("#proUserWReport").empty();var k=window.readOnly?"":'<i class="icon-arrows-ccw createUserWeekLyReport"></i>';$.each(window.projectUserList,function(n,m){$.each(i.split(","),function(p,q){if(m.userId==q){var o='<ul data-userid = "'+m.userId+'"><li><span class="time">'+m.name+'</span></li><li><a  class="weekly-header"> <img class="img-circle" src="'+m.logo+'"/><span class="left-arrow"></span></a></li> <li class="size-auto"> <div class="time-block corner-3"><div class="weekly-project"><p>系统未生成该'+TEXT_CONFIG.chengyuan+"周报"+k+"</p></div></div></li>"}d.panel.find("#proUserWReport").append(o)})});if(l){$.each(l,function(m,n){d.panel.find('#proUserWReport ul[data-userid="'+n.user.userId+'"]').data("userweekrepid",n.userWeekReportId);d.panel.find('#proUserWReport ul[data-userid="'+n.user.userId+'"]').find(".weekly-project").html(d.proUserWReportInfo(n))})}}}})}else{$(this).find("i").remove();if(d.panel.find("#allUser").children("i").length>0){d.panel.find("#allUser").empty()}d.panel.find('ul[data-userid="'+g+'"]').remove()}}});d.panel.on("click",".refresh",function(){var g=$(this).closest("h3");var f=$(this).closest("ul").data("userweekrepid");$.ajax({type:"post",data:{uwreportId:f},url:context+"/weeklyReport/updateuwReportTask.htm"}).done(function(h){if(h&&h.success&&h.resultData){var j=h.resultData;if(j){g.siblings("h3").find("span.red").html(j.unCompleteQuality);g.siblings("h3").find("span.green").html(j.completeQuality);g.siblings("h3").find("span.gray").html(j.totalQuality);if(j.comment!=null){var i=new RegExp("\n","g");j.comment=j.comment.replace(i,"<br>")}else{j.comment="该"+TEXT_CONFIG.chengyuan+"周报未填写"}g.closest("div.weekly-project").find("p").html(j.comment);g.closest("div.weekly-project").find("ul.userCritic").empty();$.each(j.uwReportDisscuss||[],function(l,n){var m=$('<li><img src="'+n.criticUser.logo+'" class="img-circle" title = "'+n.criticUser.name+'"> '+n.content+"</li>");g.closest("div.weekly-project").find("ul.userCritic").append(m)});g.closest("div.weekly-project").children("span").html("<i class=' icon-chat green'></i>评论（"+j.uwReportDisscuss.length+"）")}}else{if(h&&!h.success){layer.msg(h.errormsg)}else{layer.msg("请求失败")}}})});d.panel.on("click",".createUserWeekLyReport",function(){var g=$(this).closest("ul").data("userid");var h=$(this);var f=d.panel.find("#selected").data("time").split("~");$.ajax({type:"post",data:{userId:g,projectId:d.projectId,monday:f[0],sunday:f[1]},url:context+"/weeklyReport/createUserWeekLyReport.htm"}).done(function(i){if(i&&i.success&&i.resultData){var j=i.resultData;if(j){$.each(j,function(k,l){d.panel.find('#proUserWReport ul[data-userid="'+l.user.userId+'"]').data("userweekrepid",l.userWeekReportId);h.closest("div.weekly-project").html(d.proUserWReportInfo(l))})}}else{if(i&&!i.success){layer.msg(i.errormsg)}else{layer.msg("请求失败")}}})});d.panel.on("click",".btn-sure",function(){var h="";var g=$(this).prev("textarea");if(!h){h=new InputValidate(g,false,500,0,"textarea",null)}else{h.target.removeClass("error")}if(!h.checkValidate()||g.val().length==0){return false}var i=$(this);i.prop("disabled",true);var k=$(this).closest("ul").data("userweekrepid");var j=$(this).prev("textarea").val();var f=$(this).prev("textarea");$.ajax({type:"post",data:{userWeekReportId:k,content:j},url:context+"/weeklyReport/adduwReportComment.htm",beforeSend:function(){var l=false;if(!h.checkValidate()){l=true}if(l){i.prop("disabled",false);return false}return true}}).done(function(l){if(l&&l.success){f.val("");var m=i.closest("div").prev("ul");var n=i.closest("div.weekly-chat").prev("span");var o=n.text().replace("）","").replace("评论","").replace("（","");n.html('<i class=" icon-chat green"></i>评论（'+(o*1+1)+"）");m.append('<li><img title="'+loginUserInfo.name+'" src="'+loginUserInfo.logo+'" class="img-circle"> '+j+"</li>");i.prop("disabled",false)}else{if(l&&!l.success){layer.msg(l.errormsg)}else{layer.msg("请求失败")}}})});var e=d.panel.find("#selectWeek");d.panel.on("click","#selected",function(f){e.show();var g=$(this).data("time");e.find("li").each(function(){if($(this).data("time")==g){$(this).find("i").show()}else{$(this).find("i").hide()}});return false});e.on("click","li",function(g){var f=d.panel.find("#selected");e.find("i").hide();$(this).find("i").show();f.data("time",$(this).data("time"));f.html($(this).text()+'<i class=" icon-down-dir"></i>');e.hide();var h=f.data("time").split("~");var i="";d.panel.find(".check-box").each(function(){if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){i+=$(this).closest("li").data("userid")+","}});if(i.length>0){i=i.substring(0,i.length-1)}$.ajax({type:"post",data:{monday:h[0],userIds:i,projectId:d.projectId},url:context+"/weeklyReport/findUsersWReportByProId.htm"}).done(function(j){if(j&&j.success&&j.resultData){var l=j.resultData;d.panel.find("#proUserWReport").empty();var k=window.readOnly?"":'<i class="icon-arrows-ccw createUserWeekLyReport"></i>';$.each(window.projectUserList,function(n,m){$.each(i.split(","),function(p,q){if(m.userId==q){var o='<ul data-userid = "'+m.userId+'"><li><span class="time">'+m.name+'</span></li><li><a  class="weekly-header"> <img class="img-circle" src="'+m.logo+'"/><span class="left-arrow"></span></a></li> <li class="size-auto"> <div class="time-block corner-3"><div class="weekly-project"><p>系统未生成该'+TEXT_CONFIG.chengyuan+"周报"+k+"</p></div></div></li>"}d.panel.find("#proUserWReport").append(o)})});if(l){$.each(l,function(m,n){d.panel.find('#proUserWReport ul[data-userid="'+n.user.userId+'"]').data("userweekrepid",n.userWeekReportId);d.panel.find('#proUserWReport ul[data-userid="'+n.user.userId+'"]').find(".weekly-project").html(d.proUserWReportInfo(n))})}}else{if(j&&!j.success){layer.msg(j.errormsg)}else{layer.msg("请求失败")}}})});d.panel.find(".nav-tabs").on("click","li",function(){if($(this).hasClass("active")){return false}var f=$(this).siblings("li").removeClass("active").end().addClass("active").data("type");d.hideOrShowUserWReport(f);return})},viewInit:function(){var d=this,e="";var f=window.projectUserList;d.panel.find("#userList").empty();if(f){$.each(f,function(h,g){var i=g.name;if(g.name.length>5){i=g.name.substr(0,5)+"..."}d.panel.find("#userList").append('<li data-userid = "'+g.userId+'"><span class="check-box"><i class="icon-ok"></i></span>  <img class="img-circle" src="'+g.logo+'" /><a title="'+g.name+'">'+i+"</a></li>")})}d.panel.find(".check-box").each(function(){if($(this).children("i").length>0&&$(this).closest("li").data("userid")>0){e+=$(this).closest("li").data("userid")+","}});e=e.substring(0,e.length-1);$.ajax({type:"post",url:context+"/weeklyReport/initUsersWReportByProId.htm",data:{userIds:e,projectId:d.projectId},success:function(g){if(g&&g.success&&g.resultData){var k=g.resultData;d.panel.find("#proUserWReport").empty();if(k&&k.dateList&&k.dateList.length>0){d.panel.find("#isOrNotUserReport").hide();d.panel.find("#userWeeklyReport  .dynamic-state").show();var j=window.readOnly?"":'<i class="icon-arrows-ccw createUserWeekLyReport"></i>';$.each(f,function(m,l){var i='<ul data-userid = "'+l.userId+'"><li><span class="time">'+l.name+'</span></li><li><a  class="weekly-header"> <img class="img-circle" src="'+l.logo+'"/><span class="left-arrow"></span></a></li> <li class="size-auto"> <div class="time-block corner-3"><div class="weekly-project"><p>系统未生成该'+TEXT_CONFIG.chengyuan+"周报"+j+"</p></div></div></li>";d.panel.find("#proUserWReport").append(i)});var h=0;d.panel.find("#selectWeek").empty();$.each(k.dateList,function(n,q){var r=new Date(),m=r.getFullYear();var o=new RegExp(m+".","g");var p=new RegExp(m-1+".","g");var i=q.replace(o,"").replace(p,"");h++;if(h==1){d.panel.find("#selectWeek_div").append('<a id="selected" data-time="'+q+'">'+i+'<i class=" icon-down-dir"></i></a>')}var l=$('<li data-time="'+q+'"><a>'+i+'</a><i class=" icon-ok"></i></li>');d.panel.find("#selectWeek").append(l)});d.panel.find("div#isOrNotUserReport").text("")}else{d.panel.find("#displayTime").empty();d.panel.find("#userWeeklyReport  .dynamic-state").hide();d.panel.find("#isOrNotUserReport").show();d.panel.find("#isOrNotUserReport").html('<div class="none-content"><i class="icon-clipboard-1"></i><br /><a>暂无成员周报</a></div>')}if(k&&k.uwReport){$.each(k.uwReport,function(i,l){d.panel.find('#proUserWReport ul[data-userid="'+l.user.userId+'"]').data("userweekrepid",l.userWeekReportId);d.panel.find('#proUserWReport ul[data-userid="'+l.user.userId+'"]').find(".weekly-project").html(d.proUserWReportInfo(l))})}}else{layer.msg("请求失败")}}})},proUserWReportInfo:function(h){var f=window.readOnly?"":'<textarea placeholder="说点什么吧" class="form-control"></textarea><button class="btn btn-sure"> 回复 </button>';var i="";if(h.comment!=null){var g=new RegExp("\n","g");i=h.comment.replace(g,"<br>")}else{i="该"+TEXT_CONFIG.chengyuan+"周报未填写"}var e=window.readOnly?"":'<i class="icon-arrows-ccw refresh" title="刷新"></i>';var d=$('<div class="weekly-task"><h6>本周任务</h6><h3><span class="red">'+h.unCompleteQuality+'</span><br>未完成任务</h3><h3><span class="green">'+h.completeQuality+'</span><br>任务完成</span></h3><h3><span class="gray">'+h.totalQuality+"</span><br> 任务总数 </h3><h3>"+e+"</h3></div><h6>任务总结 </h6><p >"+i+'</p><span class="green"><i class=" icon-chat green"></i>评论（'+h.uwReportDisscuss.length+'）</span><div class=" little-portrait weekly-chat"><ul class="userCritic"></ul> <div class="comment-area">'+f+"  </div></div> ");if(h.uwReportDisscuss.length>0){$.each(h.uwReportDisscuss,function(j,m){var l=$('<li><img src="'+m.criticUser.logo+'" class="img-circle" title = "'+m.criticUser.name+'"> '+m.content+"</li>");d.find(".userCritic").append(l)})}return d},hideOrShowUserWReport:function(f){var d=this,e=d.panel.find("#userWeeklyReport"),g=d.panel.find("#proWeeklyReport");if(f=="userWReport"){e.removeClass("tohide");g.addClass("tohide");d.panel.find("#selectWeek").hide()}else{if(f=="proWReport"){e.addClass("tohide");g.removeClass("tohide");c.initProWeekReport()}}}};a.init()});