require(["jquery"],function(a){var b;b={init:function(){this.projectId=0;this.panel=a("#userWeekRep");this.allPanel=a("#myPersonalInfo");this.setEvent();this.updateUWReportInfo()},setEvent:function(){var c=this;a.ajax({type:"post",url:context+"/weeklyReport/initUserWeekReportInfo.htm"}).done(function(f){if(f&&f.success&&f.resultData){var h=f.resultData;var g=0;if(h.dateList&&h.dateList.length>0){c.panel.find("#userWeeklyDisplay").show();c.panel.find("#selectWeek").empty();a.each(h.dateList,function(l,o){var p=new Date(),k=p.getFullYear();var m=new RegExp(k+".","g");var n=new RegExp(k-1+".","g");var i=o.replace(m,"").replace(n,"");g++;if(g==1){c.panel.find("#selectWeek_btn").append('<a data-time = "'+o+'"><i class="icon-calendar"></i>'+i+'<i class=" icon-down-open-big"></i></a>')}var j=a('<li data-time="'+o+'"><a>'+i+'</a><i class=" icon-ok"></i></li>');c.panel.find("#selectWeek").append(j)})}else{c.panel.html(' <div class="none-content"><i class="icon-clipboard-1"></i><br /><a>暂无个人周报</a></div>')}if(h.uwReport){c.panel.find("#selectProject").empty();c.panel.find("#selectProject").append('<li data-projectid="0"><a>'+TEXT_CONFIG.xiangmu+'选择</a><i class=" icon-ok"></i></li>');a.each(h.uwReport,function(i,j){c.panel.find("#selectProject").append('<li data-projectid="'+j.project.projectId+'"><a>'+j.project.name+'</a><i class=" icon-ok"></i></li>');c.panel.find("#uwReportInfo").append(c.userWReportInfo(j))})}}else{if(f&&!f.success){layer.msg(f.errormsg)}else{layer.msg("请求失败")}}});var e=c.panel.find("#selectProject");c.panel.find("button#selectProject_btn").on("click",function(){c.panel.find("#selectWeek").hide();var f=c.projectId;c.panel.find("#selectProject li").each(function(){if(a(this).data("projectid")==f){a(this).find("i").show()}else{a(this).find("i").hide()}});e.show();return false});e.on("click","li",function(h){var f=c.panel.find("#selectProject_btn");var g=a(this).data("projectid");e.find("i").hide();a(this).find("i").show();f.html("<a>"+a(this).text()+'<i class=" icon-down-open-big"></i></a> ');e.hide();c.projectId=g;if(g>0){var i=a("h4[data-projectid= '"+g+"']",c.panel).closest("div.time-block");i.siblings("div.time-block").hide().end().show()}else{a("div.time-block").show()}});var d=c.panel.find("#selectWeek");c.panel.find("#selectWeek_btn").on("click",function(){var f=a(this).find("a").data("time");c.panel.find("#selectProject").hide();d.find("li").each(function(){if(a(this).data("time")==f){a(this).find("i").show()}else{a(this).find("i").hide()}});d.show();return false});d.on("click","li",function(g){var f=c.panel.find("#selectWeek_btn");var i=a(this).data("time");d.find("i").hide();a(this).find("i").show();f.find("a").data("time",i);f.find("a").html('<i class="icon-calendar"></i>'+a(this).text()+'<i class=" icon-down-open-big"></i>');d.hide();var h=i.split("~");a.ajax({type:"post",data:{monday:h[0]},url:context+"/weeklyReport/findUWReport.htm"}).done(function(j){if(j&&j.success&&j.resultData){var k=j.resultData;c.panel.find("#uwReportInfo").empty();if(k.length<=0){return false}c.panel.find("#selectProject").empty();c.panel.find("#selectProject_btn").html("<a>"+TEXT_CONFIG.xiangmu+'选择<i class=" icon-down-open-big"></i></a> ');c.panel.find("#selectProject").html("<li data-projectid=0><a>"+TEXT_CONFIG.xiangmu+'选择</a><i class=" icon-ok"></i></li>');a.each(k,function(l,m){c.panel.find("#uwReportInfo").append(c.userWReportInfo(m));c.panel.find("#selectProject").append('<li data-projectid="'+m.project.projectId+'"><a>'+m.project.name+'</a><i class=" icon-ok"></i></li>')});c.projectId=0;return false}else{if(j&&!j.success){layer.msg(j.errormsg)}else{layer.msg("请求失败")}}return false})})},updateUWReportInfo:function(){var c=this,d="";c.allPanel.on("click",function(){c.panel.find("#selectWeek").hide();c.panel.find("#selectProject").hide()});c.panel.on("click",".icon-pencil",function(){a(this).prop("disabled",true);var e=a(this).closest("h6").next("div.comment_div");var h=e.find("p").html();var f=new RegExp("<br>","g");var g=h.replace(f,"\n");e.empty();e.append('<textarea class="form-control noborder">'+g+"</textarea>");e.find("textarea").focus()});c.panel.on("blur","textarea.noborder",function(){d=a(this);var e;if(!e){e=new InputValidate(d,false,500,0,"textarea",null)}else{e.target.removeClass("error")}if(!e.checkValidate()){return}var f=a(this).closest("div").prev("h6").find("i");var h=a(this).closest("div");var i=a(this).val();var g=a(this).closest("div.time-block").data("userweekrepid");a.ajax({type:"post",data:{userWeekReportId:g,comment:i},url:context+"/weeklyReport/updateUserWRep.htm"}).done(function(j){if(j&&j.success){h.empty();var k=new RegExp("\n","g");var l=i.replace(k,"<br>");h.append("<p>"+l+"</p>");f.prop("disabled",false)}else{if(j&&!j.success){layer.msg(j.errormsg)}else{layer.msg("请求失败")}}})});c.panel.on("click",".icon-arrows-ccw",function(){var f=a(this).closest("h3");var e=a(this).closest("div.time-block").data("userweekrepid");a.ajax({type:"post",data:{uwreportId:e},url:context+"/weeklyReport/updateuwReportTask.htm"}).done(function(g){if(g&&g.success&&g.resultData){var h=g.resultData;f.siblings("h3").find("span.red").html(h.unCompleteQuality);f.siblings("h3").find("span.green").html(h.completeQuality);f.siblings("h3").find("span.gray").html(h.totalQuality);f.closest("div.weekly-project").find("ul.userCritic").empty();if(h.uwReportDisscuss){a.each(h.uwReportDisscuss,function(i,l){var j=a('<li><img src="'+l.criticUser.logo+'" class="img-circle" title = "'+l.criticUser.name+'"> '+l.content+"</li>");f.closest("div.weekly-project").find("ul.userCritic").append(j)});f.closest("div.weekly-project").children("a").html("<i class=' icon-chat green'></i>评论（"+h.uwReportDisscuss.length+"）")}}else{if(g&&!g.success){layer.msg(g.errormsg)}else{layer.msg("请求失败")}}})});c.panel.on("click",".btn-sure",function(){var h=a(this),g="";var f=h.prev("textarea");if(!g){g=new InputValidate(f,false,500,0,"textarea",null)}else{g.target.removeClass("error")}if(!g.checkValidate()||f.val().length==0){return false}h.prop("disabled",true);var j=a(this).closest("div.time-block").data("userweekrepid");var i=a(this).prev("textarea").val();var e=a(this).prev("textarea");a.ajax({type:"post",data:{userWeekReportId:j,content:i},url:context+"/weeklyReport/adduwReportComment.htm",beforeSend:function(){var k=false;if(!g.checkValidate()){k=true}if(k){h.prop("disabled",false);return false}return true}}).done(function(k){if(k&&k.success){h.prop("disabled",false);e.val("");var l=h.closest("div").prev("ul");var m=h.closest("div.weekly-chat").prev("a");var n=m.text().replace("）","").replace("评论（","");l.append('<li><a><img title="'+loginUserInfo.name+'" src="'+loginUserInfo.logo+'" class="img-circle"> '+i+"</a></li>");m.html('<i class=" icon-chat green"></i>评论（ '+(n*1+1)+"）")}else{if(k&&!k.success){layer.msg(k.errormsg)}else{layer.msg("请求失败")}}})})},userWReportInfo:function(e){var f="";if(e.comment){var d=new RegExp("\n","g");f=e.comment.replace(d,"<br>")}var c=a('<div class="time-block corner-3 " data-userweekrepid = "'+e.userWeekReportId+'"><div class="weekly-project"><h4 data-projectid = "'+e.project.projectId+'"><i class="icon-tasks-1"></i>'+e.project.name+'</h4><h6>本周任务</h6><div class="weekly-task"><h3><span class="red">'+e.unCompleteQuality+'</span><br>未完成任务</h3><h3><span class="green">'+e.completeQuality+'</span><br>任务完成</span></h3><h3><span class="gray">'+e.totalQuality+'</span><br> 任务总数 </h3><h3><i class=" icon-arrows-ccw" title="刷新"></i></h3></div><h6>任务总结<i class=" icon-pencil" title="修改"></i></h6><div class="comment_div"> <p>'+f+'</p></div> <a  class="green"><i class=" icon-chat green"></i>评论（'+e.uwReportDisscuss.length+'）</a><div class=" little-portrait weekly-chat"><ul class="userCritic"></ul><div class="comment-area"><textarea placeholder="说点什么吧" class="form-control textareaComments"></textarea><button class="btn btn-sure"> 回复 </button></div></div></div></div> ');if(e.uwReportDisscuss.length>0){a.each(e.uwReportDisscuss,function(g,i){var h=a('<li><a><img src="'+i.criticUser.logo+'" class="img-circle" title="'+i.criticUser.name+'"> '+i.content+"</a></li>");c.find(".userCritic").append(h)})}return c}};b.init()});