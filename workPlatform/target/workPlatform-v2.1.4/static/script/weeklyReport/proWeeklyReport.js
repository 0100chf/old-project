define(["script/common/personList","jquery","layer"],function(c){var a=$("#proWeeklyReport");var b=a.closest("div[data-id='projectTemplate']").data("projectId");var f={},e={},h={};var d=0;var g={initProWeekReport:function(){var i=this,k=window.projectUserList,j=loginUserInfo.name;a.find("#usersPro,ul.weekly-item").empty();$.each(k,function(m,l){if(l.userEnabled){a.find("#usersPro").append('<li class="removepointer"><img src="'+l.logo+'" class="img-circle" title="'+l.name+'"></li>')}});a.find("#filledUser").html("");$.ajax({type:"post",data:{projectId:b},url:context+"/weeklyReport/initProWeekRep.htm"}).done(function(l){if(l&&l.success&&l.resultData){var o=l.resultData;var p=new Date(),n=p.getFullYear();if(o&&o.dataMap&&o.dataMap.length>0){var m=0;$.each(o.dataMap,function(r,u){var t=new RegExp(n+".","g");var s=new RegExp((n*1-1)+".","g");var q=u.replace(s,"").replace(t,"");m++;if(m==1){a.find("ul.weekly-item").append('<li class="select" data-weeks="'+u+'"><a><i class="icon-calendar"></i>'+q+"</a></li>")}else{a.find("ul.weekly-item").append('<li data-weeks="'+u+'"><a><i class="icon-calendar"></i>'+q+"</a></li>")}})}else{a.find("div#projectWeekReport_div").html('<div class="none-content"><i class="icon-clipboard-1"></i><br /><a>系统未生成本周'+TEXT_CONFIG.xiangmu+"周报数据</a></div>")}if(o&&o.pwr){i.initProWeekReportContent(o.pwr)}}else{if(l&&!l.success){layer.msg(l.errormsg)}else{layer.msg("请求失败")}}})},initProWeekReportContent:function(m){var l=this;if(m.filledUser){$.each(window.projectUserList,function(o,p){if(p.userId==m.filledUser.userId){var n=p.name;if(n.length>5){n=n.substr(0,5)+"..."}a.find("#filledUser").html('<img  src="'+p.logo+'" class="img-circle removepointer"><span title="'+p.name+'">'+n+"</span></img>")}})}a.find("textarea.weekly-control").attr("data-pwrcid",0);a.find("textarea.weekly-control").append('<i class=" icon-pencil" title="修改"></i>');a.find("#weekRisk").html('<tr><th class="width_lastRisk">问题描述</th><th class="width_lastRisk">解决方案</th><th>责任人</th></tr>');a.find("#weekWorks").html('<tr><th class="width_number">编号</th><th class="width_lastRisk">工作内容</th><th class="width_number">计划进度（%）</th><th class="width_number">完成情况（%）</th><th>责任人</th></tr>');a.find("#lastWeekWork").html('<tr><th class="width_number">编号</th><th >工作内容</th><th class="width_number">计划进度（%）</th><th >完成情况（%）</th><th>责任人</th></tr>');a.find("#lastWeekRisk").html("<tr><th>问题描述</th><th>解决方案</th><th>责任人</th></tr>");a.find("#nextWeekPlan").html('<tr><th class="width_number">编号</th><th class="width_work">工作内容</th><th>责任人</th></tr>');d=m.projectWeeklyReportId;if(m.createdString==null){m.createdString="  "}a.find("#createTime").html('<i class="icon-calendar"></i>'+m.createdString);if(m.deliveryString==null){a.find("#deliveryTime").html("未设置交付日期")}else{a.find("#deliveryTime").html('<i class="icon-calendar"></i>'+m.deliveryString)}a.find("#progress").val(m.progress);a.find("div.task-content p").html("");a.find("#status").val(m.status).attr("title",m.status);a.find("#phase").val(m.phase).attr("title",m.phase);if(m.listProWRepContents!=null){var j=m.listProWRepContents;var k=0,i=0;$.each(j,function(n,p){if(p.type=="00900"){q++;a.find("#weekRisk").append(l.weekRisk(p))}else{if(p.type=="00901"){k++;a.find("#weekWorks").append(l.weekWorks(p,k))}else{if(p.type=="00903"){i++;a.find("#nextWeekPlan").append(l.nextWeekPlan(p,i))}else{if(p.type=="00902"){var o=new RegExp("\n","g");var q=p.column4Content.replace(o,"<br>");a.find("div.task-content").attr("data-pwrcid",p.proWRepContentId);a.find("div.task-content p").html(q);a.find("div.task-content textarea").hide()}}}}})}if(m.listParentProWRepContents!=null){var j=m.listParentProWRepContents;var k=0,i=0;$.each(j,function(n,o){if(o.type=="00901"){k++;a.find("#lastWeekWork").append(l.lastWeekWorks(o,k))}else{if(o.type=="00900"){i++;a.find("#lastWeekRisk").append(l.lastWeekRisk(o))}}});if(k<=0){a.find("#lastWeekWork").html("无")}if(i<=0){a.find("#lastWeekRisk").html("无")}}},lastWeekRisk:function(j){var i=null;i=$('<tr data-pwrid="'+j.proWRepContentId+'"><td>'+j.column1Content+"</td><td>"+j.column2Content+"</td><td><ul></ul></td></tr>");if(j.users==null){}else{$.each(j.users,function(m,n){var l=$('<li data-id="'+n.userId+'" title="'+n.name+'"><img src="'+n.logo+'" class="img-circle"><a class="remove-member-handler">×</a></li>');i.find("ul").append(l)})}return i},weekRisk:function(k){var j=null,i=this;j=$('<tr data-pwrid="'+k.proWRepContentId+'"><td><input  value="'+k.column1Content+'"  class="transparency projectWeekReportContent weekRisk risk1" readonly="true"></td><td><input  value="'+k.column2Content+'"  class="transparency projectWeekReportContent weekRisk risk2" readonly="true"></td><td><ul></ul></td></tr>');if(k.users==null){}else{var l=a.find("#addProblem").length>0?true:false;$.each(k.users,function(n,o){var m=$('<li data-id="'+o.userId+'" title="'+o.name+'"><img src="'+o.logo+'" class="img-circle"></li>');if(l){m.append('<a class="remove-member-handler">×</a>')}j.find("ul").append(m)})}if(a.find("#addProblem").length>0){j.find("ul").append('<li data-id="0" class="addUser"><i class="icon-plus-circle icon-big"></i></li> <i class="icon-trash-empty" title="删除"></i>')}return j},lastWeekWorks:function(j,i){var l=null;l=$(' <tr data-pwrid="'+j.proWRepContentId+'"><td>'+i+"</td><td>"+j.column1Content+"</td><td>"+j.column2Content+"</td><td>"+j.column3Content+"</td><td><ul></ul></td></tr>");if(j.users==null){}else{var k=a.find("#addProblem").length>0?true:false;$.each(j.users,function(n,o){var m=$('<li data-id="'+o.userId+'" title="'+o.name+'"><img src="'+o.logo+'" class="img-circle"></li>');if(k){m.append('<a class="remove-member-handler">×</a>')}l.find("ul").append(m)})}return l},weekWorks:function(k,i){var m=null,j=this;m=$(' <tr data-pwrid="'+k.proWRepContentId+'"><td>'+i+'</td><td ><input  value="'+k.column1Content+'"  class="transparency projectWeekReportContent risk1" readonly="true"></td><td width="10%"><input  value="'+k.column2Content+'"  class="risk2 transparency projectWeekReportContent" readonly="true"></td><td width="10%"><input  value="'+k.column3Content+'"  class="risk3 transparency projectWeekReportContent" readonly="true"></td><td><ul></ul></td></tr>');var l=a.find("#addProblem").length>0?true:false;if(k.users==null){}else{$.each(k.users,function(o,p){var n=$('<li title="'+p.name+'" data-id="'+p.userId+'"><img src="'+p.logo+'" class="img-circle"></li>');if(l){n.append('<a class="remove-member-handler">×</a>')}m.find("ul").append(n)})}if(a.find("#addWork").length>0){m.find("ul").append('<li  data-id="0" class="addUser"><i class="icon-plus-circle icon-big"></i></li> <i class="icon-trash-empty" title="删除"></i>')}return m},nextWeekPlan:function(k,l){var j=null,i=this;j=$('<tr data-pwrid="'+k.proWRepContentId+'"><td>'+l+'</td><td><input  value="'+k.column1Content+'"  class="risk1 transparency projectWeekReportContent" readonly="true"></td><td> <ul></ul> </td> </tr>');if(k.users==null){}else{$.each(k.users,function(n,o){var m=$('<li title="'+o.name+'" data-id="'+o.userId+'"><img src="'+o.logo+'" class="img-circle"><a class="remove-member-handler">×</a></li>');j.find("ul").append(m)})}if(a.find("#addPlan").length>0){j.find("ul").append('<li  data-id="0" class="addUser"><i class="icon-plus-circle icon-big"></i></li> <i class="icon-trash-empty" title="删除"></i>')}return j},btnClick:function(){var k=this,l="",j="",i="";a.on("click",".icon-pencil",function(){$(this).prop("disabled",true);var q=$(this).nextAll("p").html();var o=new RegExp("<br>","g");var p=q.replace(o,"\n");$(this).nextAll("textarea").html(p);$(this).nextAll("textarea").show();$(this).nextAll("textarea").focus();$(this).nextAll("p").hide()});a.on("click","input.projectWeekReportContent",function(){if(a.find("#addProblem").length>0){$(this).removeClass("transparency");$(this).addClass("form-control");$(this).attr("readonly",false)}});if(a.find("#progress").hasClass("transparency")){var n=a.find("#progress");if(!l){l=new InputValidate(n,true,30,0,"percentage",null)}else{l.target.removeClass("error")}}if(a.find("#status").hasClass("transparency")){var n=a.find("#status");if(!j){j=new InputValidate(n,false,30,0,"",null)}else{j.target.removeClass("error")}}if(a.find("#phase").hasClass("transparency")){var n=a.find("#phase");if(!i){i=new InputValidate(n,false,30,0,"",null)}else{i.target.removeClass("error")}}a.on("click","input.projectWeekReport",function(){if(a.find("#addProblem").length){$(this).removeClass("transparency");$(this).addClass("form-control input-width");$(this).attr("readonly",false)}});a.on("click","#addPlan",function(){k.planValiArray={};var q=a.find("#nextWeekPlan .workriskplan1").length;if(q>=1){layer.msg("请保存后再添加");return false}var o=a.find("#nextWeekPlan tbody").children("tr").length;a.find("#nextWeekPlan").append('<tr data-type="00903" data-pwrid="0"><td>'+o+'</td><td><input  value="" class="form-control workriskplan1 risk1"></td><td> <ul><li  data-id="0" class="addUser"><i class="icon-plus-circle icon-big"></i></li><button class=" btn btn-sm-outer savePlanWRContent">保存</button><button class="cancelWRContent btn btn-sm-outer" style="background:#fff; border:1px solid #ddd; color:#808080">取消<tton></ul> </td> </tr>');var p=a.find("#nextWeekPlan .workriskplan1");p.focus()});a.on("click","#addWork",function(){k.workValiArray={};var q=a.find("#weekWorks .workriskplan1").length;if(q>=1){layer.msg("请保存后再添加");return false}var o=a.find("#weekWorks tbody").children("tr").length;a.find("#weekWorks").append('<tr data-pwrid="0" data-type="00901"><td>'+o+'</td><td><input  value="" class="form-control workriskplan1 risk1"></td><td><input  value="" class="form-control  workriskplan2 "></td><td><input  value="" class="form-control workriskplan3"></td><td><ul><li  data-id="0" class="addUser"><i class="icon-plus-circle icon-big"></i></li><button class=" btn btn-sm-outer saveWorkWRContent">保存</button><button class="cancelWRContent btn btn-sm-outer" style="background:#fff; border:1px solid #ddd; color:#808080">取消<tton></ul> </td> </tr>');var p=a.find("#weekWorks .workriskplan1");p.focus()});a.on("click","#addProblem",function(){k.riskValiArray={};var p=a.find("#weekRisk .workriskplan1").length;if(p>=1){layer.msg("请保存后再添加");return false}a.find("#weekRisk").append('<tr data-pwrid="0" data-type="00900"><td><input value="" class="form-control workriskplan1"></td><td><input value="" class="form-control workriskplan2"></td><td> <ul> <li  data-id="0" class="addUser"><i class="icon-plus-circle icon-big"></i></li><button class=" btn btn-sm-outer saveProblemWRContent">保存</button><button class="cancelWRContent btn btn-sm-outer" style="background:#fff; border:1px solid #ddd; color:#808080">取消<tton></ul></td></tr>');var o=a.find("#weekRisk .workriskplan1");o.focus()});a.on("click",".cancelWRContent",function(){$(this).closest("tr").remove()});a.on("focusout",".projectWeekReport",function(){var s=$(this);var p=$(this).attr("id");var r=a.find("#status").val();var q=a.find("#phase").val();var o=a.find("#progress").val();$.ajax({type:"post",data:{projectWeeklyReportId:d,phase:q,status:r,progress:o,type:p},url:context+"/weeklyReport/updateProWeekRep.htm",beforeSend:function(){var t=false;if(p=="phase"){if(!i.checkValidate()){t=true;return false}}else{if(p=="progress"){if(!l.checkValidate()){t=true;return false}}else{if(!j.checkValidate()){t=true;return false}}}return true}}).done(function(t){if(t&&t.success){s.addClass("transparency");if(p!="progress"){s.attr("title",s.val())}s.removeClass("form-control");s.attr("readonly",true)}else{if(t&&!t.success){layer.msg(t.errormsg)}else{layer.msg("请求失败")}}})});var m="eventSelectUser";a.on("click","ul li.addUser",function(){var o=[];$(this).prevAll("li").each(function(){o.push($(this).data("id").toString())});c.init({searchInput:true,data:window.projectUserList||{},claiming:false,selectData:o,dom:$(this),container:$(this),eventType:m});return false});a.on(m,"ul li.addUser",function(p,r){if($(this).closest("tr").attr("data-pwrid")<=0){if(r.callback){r.callback();return false}return false}var q="";$(this).prevAll("li").each(function(){q+=$(this).data("id")+","});q+=r.ids;var o={userIds:q,pwrcId:$(this).closest("tr").attr("data-pwrid"),callback:r&&r.callback};k.operatorJoninUser(o)});a.on("click",".remove-member-handler",function(){if($(this).closest("tr").attr("data-pwrid")<=0){$(this).closest("li").remove();layer.closeAll();return false}var o=$(this);var q="";$(this).closest("li").siblings("li").each(function(){if($(this).data("id")!=0){q+=$(this).data("id")+","}});if(q.length>0){q=q.substring(0,q.length-1)}var p={userIds:q,pwrcId:$(this).closest("tr").attr("data-pwrid"),callback:function(){o.closest("li").remove()}};k.operatorJoninUser(p)});a.on("focusout",".projectWeekReportContent",function(){var t="";var s=$(this),q=1;if(s.hasClass("risk1")){if(!t){t=new InputValidate($(this),true,500,0,"",null)}else{t.target.removeClass("error")}}if(s.hasClass("risk2")){q=2;if(!t){t=new InputValidate($(this),false,500,0,"",null)}else{t.target.removeClass("error")}}if(s.hasClass("risk3")){q=3;if(!t){t=new InputValidate($(this),false,500,0,"",null)}else{t.target.removeClass("error")}}var u=$(this).closest("tr").data("pwrid");var r,p,o;r=$(this).closest("tr").find(".risk1").val();if($(this).closest("tr").find(".risk2").length>0){p=$(this).closest("tr").find(".risk2").val()}else{p==null}if($(this).closest("tr").find(".risk3").length>0){o=$(this).closest("tr").find(".risk3").val()}else{o==null}$.ajax({type:"post",data:{pwrcId:u,content1:r,content2:p,content3:o,type:q},url:context+"/weeklyReport/updateProWeekRepContent.htm",beforeSend:function(){var v=false;if(!t.checkValidate()){v=true;return false}return true}}).done(function(v){if(v&&v.success){s.addClass("transparency");s.removeClass("form-control");s.attr("readonly",true)}else{if(v&&!v.success){layer.msg(v.errormsg)}else{layer.msg("请求失败")}}})});a.on("click",".saveProblemWRContent",function(){h={};var p=$(this);p.prop("disabled",true);var t=p.closest("tr");var u="";var r=t.data("type");t.find(".addUser").prevAll("li").each(function(){u+=$(this).data("id")+","});if(u.length>0){u=u.substring(0,u.length-1)}var o=t.find(".workriskplan1");var s,q;s=o.val();if(!h.content1){h.content1=new InputValidate(o,true,500,0,"",null)}else{h.content1.target.removeClass("error")}var v=t.find(".workriskplan2");q=v.val();if(!h.content2){h.content2=new InputValidate(v,false,500,0,"",null)}else{h.content2.target.removeClass("error")}$.ajax({type:"post",data:{pwrId:d,content1:s,content2:q,content3:null,type:r,userIds:u},url:context+"/weeklyReport/saveProWeekRepContent.htm",beforeSend:function(){var w=false;$.each(h,function(x,y){if(!y.checkValidate()){w=true;return false}});if(w){p.prop("disabled",false);return false}return true},success:function(w){if(w&&w.success&&w.resultData){k.wRContentValiArray={};var x=w.resultData;o.addClass("transparency risk1 projectWeekReportContent").removeClass("workriskplan1 form-control").attr("readonly",true);if(v.length>0){v.addClass("transparency risk2 projectWeekReportContent").removeClass("form-control workriskplan2").attr("readonly",true)}t.attr("data-pwrid",x);p.next("button").remove();p.remove();t.find(".addUser").after('<i class="icon-trash-empty" title="删除"></i>')}else{if(w&&!w.success){layer.msg(w.errormsg)}else{layer.msg("请求失败")}}}})});a.on("click",".saveWorkWRContent",function(){e={};var r=$(this);r.prop("disabled",true);var t=r.closest("tr");var s="";var x=t.data("type");t.find(".addUser").prevAll("li").each(function(){s+=$(this).data("id")+","});if(s.length>0){s=s.substring(0,s.length-1)}var w=t.find(".workriskplan1");var q,p,o;q=w.val();if(!e.content1){e.content1=new InputValidate(w,true,500,0,"",null)}else{e.content1.target.removeClass("error")}var v=t.find(".workriskplan2");p=v.val();if(!e.content2){e.content2=new InputValidate(v,false,500,0,"",null)}else{e.content2.target.removeClass("error")}var u=t.find(".workriskplan3");o=u.val();if(!e.content3){e.content3=new InputValidate(u,false,500,0,"",null)}else{e.content3.target.removeClass("error")}$.ajax({type:"post",data:{pwrId:d,content1:q,content2:p,content3:o,type:x,userIds:s},url:context+"/weeklyReport/saveProWeekRepContent.htm",beforeSend:function(){var y=false;$.each(e,function(z,A){if(!A.checkValidate()){y=true;return false}});if(y){r.prop("disabled",false);return false}return true},success:function(y){if(y&&y.success&&y.resultData){k.wRContentValiArray={};var z=y.resultData;w.addClass("transparency risk1 projectWeekReportContent").removeClass("form-control workriskplan1").attr("readonly",true);v.addClass("transparency risk2 projectWeekReportContent").removeClass("form-control workriskplan2").attr("readonly",true);u.addClass("transparency risk3 projectWeekReportContent").removeClass("form-control workriskplan3").attr("readonly",true);t.attr("data-pwrid",z);r.next("button").remove();r.remove();t.find(".addUser").after('<i class="icon-trash-empty" title="删除"></i>')}else{if(y&&!y.success){layer.msg(y.errormsg)}else{layer.msg("请求失败")}}}})});a.on("click",".savePlanWRContent",function(){f={};var p=$(this);p.prop("disabled",true);var s=p.closest("tr");var t="";var q=s.data("type");s.find(".addUser").prevAll("li").each(function(){t+=$(this).data("id")+","});if(t.length>0){t=t.substring(0,t.length-1)}var o=s.find(".workriskplan1");var r;r=o.val();if(!f.content1){f.content1=new InputValidate(o,true,500,0,"",null)}else{f.content1.target.removeClass("error")}$.ajax({type:"post",data:{pwrId:d,content1:r,content2:null,content3:null,type:q,userIds:t},url:context+"/weeklyReport/saveProWeekRepContent.htm",beforeSend:function(){var u=false;$.each(f,function(v,w){if(!w.checkValidate()){u=true;return false}});if(u){p.prop("disabled",false);return false}return true},success:function(u){if(u&&u.success&&u.resultData){k.wRContentValiArray={};var v=u.resultData;o.addClass("transparency risk1 projectWeekReportContent").removeClass("form-control workriskplan1").attr("readonly",true);s.attr("data-pwrid",v);p.next("button").remove();p.remove();s.find(".addUser").after('<i class="icon-trash-empty" title="删除"></i>')}else{if(u&&!u.success){layer.msg(u.errormsg)}else{layer.msg("请求失败")}}}})});a.on("click",".icon-trash-empty",function(){$(this).prop("disabled",true);var o=$(this).closest("tr");var p=o.data("pwrid");$.ajax({type:"post",data:{pwrcId:p},url:context+"/weeklyReport/deletepwrContent.htm"}).done(function(q){if(q&&q.success){var r=o.closest("table");o.remove();if(r.attr("id")=="weekWorks"||r.attr("id")=="nextWeekPlan"){r.find(".risk1").each(function(){var s=$(this).closest("tr").prevAll("tr").length;$(this).closest("td").prev("td").text(s)})}}else{if(q&&!q.success){layer.msg(q.errormsg)}else{layer.msg("请求失败")}}})});a.on("focusout","textarea.weekly-control",function(){var p=$(this),o="";if(!o){o=new InputValidate(p,false,500,0,"textarea",null)}else{o.target.removeClass("error")}if(!o.checkValidate()){return}var q=$(this).closest("div").attr("data-pwrcid");var p=$(this).val();$.ajax({type:"post",data:{pwrId:d,content:p,pwrcId:q},url:context+"/weeklyReport/updateWorkContent.htm"}).done(function(r){if(r&&r.success){var s=new RegExp("\n","g");var u=p.replace(s,"<br>");a.find("div.task-content p").html(u);a.find("div.task-content p").show();a.find("div.task-content textarea").hide();var t=r.resultData;a.find("div.task-content").attr("data-pwrcid",t);a.find("div.task-content i ").prop("disabled",false)}else{if(r&&!r.success){layer.msg(r.errormsg)}else{layer.msg("请求失败")}}})});a.find("ul.weekly-item").on("click","li",function(){$(this).siblings("li").removeClass("select").end().addClass("select");var o=$(this).data("weeks").split("~")[0];$.ajax({type:"post",data:{projectId:b,monday:o},url:context+"/weeklyReport/findProWeekReport.htm"}).done(function(p){if(p&&p.success){var q=p.resultData;if(q&&q.projectWeeklyReportId){k.initProWeekReportContent(q)}else{a.find("div#projectWeekReport_div").html('<div class="none-content"><i class="icon-clipboard-1"></i><br /><a>系统未生成本周'+TEXT_CONFIG.xiangmu+"周报数据</a></div>")}}else{if(p&&!p.success){layer.msg(p.errormsg)}else{layer.msg("请求失败")}}})})},operatorJoninUser:function(j){var i={userIds:j.userIds,ids:j.ids,pwrcId:j.pwrcId};$.ajax({type:"post",data:i,url:context+"/weeklyReport/operatorJoninUser.htm"}).done(function(k){if(k&&k.success){if(j.callback){j.callback()}}else{if(k&&!k.success&&k.errormsg){layer.alert(k.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){})}};return g});