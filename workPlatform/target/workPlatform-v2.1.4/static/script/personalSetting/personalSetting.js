require(["script/common/dialogAlert","jquery","jqueryForm","layer"],function(b){var a;a={init:function(){this.panel=$("#pesonsetting_div");this.settingTypeUl=$("#setting_type_ul",this.panel);this.loginUserInfo=loginUserInfo;this.setEvent();this.personValiArray={};this.safeValiArray={};this.panel.on("removenull","input",function(){if(!$(this).val()||$(this).val()=="null"){$(this).val("")}});this.personalPageInit()},setEvent:function(){var c=this;if(c.loginUserInfo.action=="false"){c.panel.find("#activateDiv").show()}this.settingTypeUl.on("click","li",function(){var d=$(this).siblings("li").removeClass("active").end().addClass("active").data("type");c.hideOrShowSettingPage(d)});this.panel.on("change",'form.personal_form input[type="file"]',function(){var h=$("#input_pic_upload");var f=this.files;if(f.length!=0){var e=f[0],d=new FileReader();if(!d){b.alert("该浏览器不支持头像上传");return}var g=new RegExp("image/(png|jpeg|jpg|gif|)","g");if(!g.test(e.type)){b.alert("请选择正确格式的图片");h.after(h.clone(true).val(""));h.remove();return}if(e.limitSize("1","MB")){h.after(h.clone(true).val(""));h.remove();b.alert("头像太大，应1MB以内");return}d.onload=function(i){var j=EventUtil.getTarget(i);c.panel.find("#headerpic_img").prop("src",j.result)};d.readAsDataURL(e)}});this.panel.on("click",'form button[name="button"]',function(h){EventUtil.preventDefault(h);var g=$(this),f={},e=g.closest("form"),d=e.hasClass("personal_form");g.prop("disabled",true);var k={};if(d){k=new FormData(e[0]);k.append("account",loginUserInfo.account);f.validateArray=c.personValiArray;f.url=context+"/login/updatePersionInfo.htm"}else{k=new FormData();k.append("account",loginUserInfo.account);var i={},j=e.formToArray();$.each(j,function(l,m){i[m.name]=m.value});i.password=hex_hmac_md5(loginUserInfo.account,i.password);k.append("password",i.password);i.newpwd=hex_hmac_md5(loginUserInfo.account,i.newpwd);k.append("newpwd",i.newpwd);f.validateArray=c.safeValiArray;f.url=context+"/login/updateSafeInfo.htm"}$.ajax({type:"post",url:f.url,data:k,contentType:false,processData:false,beforeSend:function(){var l=false;$.each(f.validateArray,function(m,n){if(!n.checkValidate()){l=true;return false}});if(l){g.prop("disabled",false);return false}return true},success:function(l){if(l&&l.success){var n=l.resultData;var m=c.loginUserInfo;if(d){m.name=n.name;m.mobile=n.mobile;m.postion=n.positon;m.gender=n.gender;m.logo=n.logo;layer.alert("个人信息修改成功",1,"信息",function(o){window.location=context+"/project/home.htm"})}else{layer.alert("密码修改成功，请重新登录",1,"信息",function(o){window.location=context+"/login/loginout.htm"})}}else{if(l&&!l.success&&l.errormsg){b.alert(l.errormsg,5)}else{layer.alert("请求失败",1)}}g.prop("disabled",false)},error:function(l){layer.alert("请求失败",1);g.prop("disabled",false)}})});this.panel.on("click","#activateUser",function(){var d=$(this);d.prop("disabled",false);$.ajax({type:"post",url:context+"/user/activateAccount.htm",data:{account:c.loginUserInfo.account},success:function(e){if(e&&e.success){var f=e.resultData;b.alert(f,9);return false}else{if(e&&!e.success&&e.errormsg){b.alert(e.errormsg,5)}else{layer.alert("请求失败",1)}}return false;d.prop("disabled",false)},error:function(e){layer.alert("请求失败",1);d.prop("disabled",false)}})})},hideOrShowSettingPage:function(c){if(c=="person"){this.panel.find(".setting_children").addClass("tohide").end().find(".setting_children:eq(0)").removeClass("tohide");this.personalPageInit();return}else{if(c=="safety"){this.panel.find(".setting_children").addClass("tohide").end().find(".setting_children:eq(1)").removeClass("tohide");this.safetyPageInit();return}else{return}}},personalPageInit:function(){var d=this;var f=this.panel.find("form.personal_form input[name='name']"),h=this.panel.find("form.personal_form select[name='gender']"),c=this.panel.find("form.personal_form input[name='mobile']"),e=this.panel.find("form.personal_form input[name='position']");f.val(loginUserInfo.name).trigger("removenull");c.val(loginUserInfo.mobile).trigger("removenull");e.val(loginUserInfo.position).trigger("removenull");d.panel.find("span.boardBackground").show();d.panel.find(".icon-pencil-1").unbind("click").click(function(i){d.panel.find('form.personal_form input[type="file"]').click()});if(loginUserInfo.logo&&loginUserInfo.logo!="null"){this.panel.find("#headerpic_img").attr("src",loginUserInfo.logo)}else{this.panel.find("#headerpic_img").attr("src",context+"/static/images/head-portraits-chart.png")}var g=this.panel.find('form.personal_form input[type="file"]');g.after(g.clone(true).val(""));g.remove();if(!this.personValiArray.name){this.personValiArray.name=new InputValidate(f,true,30,0,"",null)}else{this.personValiArray.name.target.removeClass("error")}if(!this.personValiArray.mobile){this.personValiArray.mobile=new InputValidate(c,false,30,0,"telphone",null)}else{this.personValiArray.mobile.target.removeClass("error")}if(!this.personValiArray.position){this.personValiArray.position=new InputValidate(e,false,30,0,"",null)}else{this.personValiArray.position.target.removeClass("error")}$.post(context+"/personal/listSysStatus.htm",function(i){h.empty();if(i&&i.success){var j=i.resultData;$.each(j,function(l,m){var k=$("<option/>").val(m.code).html(m.text);h.append(k)});h.val(loginUserInfo.gender)}})},safetyPageInit:function(){var d=this;var f=this.panel.find("form.safety_form label[name='account']"),c=this.panel.find("form.safety_form input[name='password']"),g=this.panel.find("form.safety_form input[name='newpwd']"),e=this.panel.find("form.safety_form input[name='confirmpwd']");f.empty().html("&nbsp;&nbsp;"+loginUserInfo.account);c.val("");g.val("");e.val("");d.panel.find("span.boardBackground").hide();d.headerVlaue=null;if(loginUserInfo.logo&&loginUserInfo.logo!="null"){this.panel.find("#headerpic_img").attr("src",loginUserInfo.logo)}else{this.panel.find("#headerpic_img").attr("src",context+"/static/images/pic-project2.jpg")}if(!this.safeValiArray.password){this.safeValiArray.password=new InputValidate(c,true,30,0,"",null)}else{this.safeValiArray.password.target.removeClass("error")}if(!this.safeValiArray.newpwd){this.safeValiArray.newpwd=new InputValidate(g,true,30,0,"password",null)}else{this.safeValiArray.newpwd.target.removeClass("error")}if(!this.safeValiArray.confirmpwd){this.safeValiArray.confirmpwd=new InputValidate(e,true,30,0,"password",null,g)}else{this.safeValiArray.confirmpwd.target.removeClass("error")}}};a.init()});