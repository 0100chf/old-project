var currentModiFile=null;require(["script/fileLibrary/fileMove","jqueryForm","jquery","layer"],function(b){var a={init:function(){this.panel=$(".filelibrary-content");this.projectId=this.panel.closest("div[data-id='projectTemplate']").data("projectId");this.fileData={propertyTemp:"filelibrary_"};this.viewInit();this.setEvent()},setEvent:function(){var d=this;d.panel.on("click","a.a_folder",function(){var i=$(this),f=i.closest("tr").attr("data-fileId"),h=i.find("input.transparency"),g=i.attr("data-isfolder");if(h.length<=0){return false}if(g=="true"){d.getFileChidren(f)}if(g=="false"){}return false});d.panel.on("dblclick","a.a_folder",function(){return false});d.panel.on("click","span.route a",function(){var g=$(this),f=g.closest("a").attr("data-fileId");d.getFileChidren(f);return false});var c="",e="";d.panel.on("click","button.button_new_folder",function(){if(d.panel.find("tbody.tbody_file_manage").children("tr").length<=0){d.panel.find("tbody.tbody_file_manage").empty()}var h=d.panel.find("tbody.tbody_file_manage"),f="";f+='<tr data-fileId="0">';f+='<td><a class="a_folder"><i class="icon-folder-2"></i><input temp="newFolder" class="input_file_name"/></a></td>';f+="<td></td>";f+="<td></td>";f+="<td></td>";f+="</tr>";var g=h.find("tr:first");if(g.length>0){g.before(f)}else{h.append(f)}h.find('input[temp="newFolder"]').focus();c=d.panel.find("input.input_file_name");e=new InputValidate(c,true,80);currentModiFile="";return false});d.panel.on("click","i.icon-edit",function(){var f=$(this),g=f.closest("tr").find("input.input_file_name");g.removeClass("transparency").prop("readonly","");g.select();c=d.panel.find("input.input_file_name");e=new InputValidate(c,false,80);currentModiFile=g.attr("value");return false});d.panel.on("blur","input.input_file_name",function(){if(currentModiFile==null){return false}var i=$(this),g=i.closest("tr").attr("data-fileId"),j=i.closest("tr").find("input.input_file_name").val(),f=d.panel.find("span.route").attr("data-currentfileid");var h=i.closest("tr").find("a[data-isfolder]").attr("data-isfolder");if(!j||j.length<=0||(h=="false"&&(j.indexOf(".")<=0))){d.getFileChidren(f);return}if(e&&!e.checkValidate()){return false}if(g>0&&j==currentModiFile){d.getFileChidren(f);return false}if(h=="false"&&j.indexOf(".")>=0&&currentModiFile.indexOf(".")>=0&&j.split(".")[j.split(".").length-1].toLowerCase()!=currentModiFile.split(".")[currentModiFile.split(".").length-1].toLowerCase()){layer.alert("文件名扩展名不可改变！",1);d.getFileChidren(f);return false}$.ajax({type:"post",url:context+"/filelibrary/operatorfilelibrary.htm",data:{fileId:g,fileName:j,projectId:d.projectId,folderId:f}}).done(function(k){if(k&&k.success){return}else{if(k&&!k.success&&k.errormsg){layer.alert(k.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)}).always(function(){currentModiFile=null;var k=d.fileData.propertyTemp;d.fileData[k+f]=null;d.getFileChidren(f)})});d.panel.on("click","button.button_upload_file",function(){var f=d.panel.find("span.route").attr("data-currentfileid");d.panel.find("form.file_upload_form").find("input.file_library_input").attr("value",f).end().find("input.file_project_input").attr("value",d.projectId).end().find("input.file_upload_input").click();return false});d.panel.on("change","input.file_upload_input",function(){var f=layer.load();var i=this,h=i.files,g={beforeSubmit:function(){if(!h||h.length>0){if(h[0].limitSize(500,"MB")){layer.alert("附件太大，无法上传，请限制500MB以内");$(i).after($(i).clone(true).val(""));$(i).remove();return false}return true}return false},success:function(l){if(l&&l.success){var k=d.fileData.propertyTemp,j=d.panel.find("span.route").attr("data-currentfileid");d.fileData[k+j]=null;d.getFileChidren(j);return}else{if(l&&!l.success&&l.errormsg){layer.alert(l.errormsg,1)}else{layer.alert("请求失败",1)}}},error:function(j){layer.alert("请求失败",1)},complete:function(){layer.close(f);$(i).after($(i).clone(true).val(""));$(i).remove()}};$(i).closest("form.file_upload_form").ajaxSubmit(g);return false});d.panel.on("click","i.icon-download",function(){var f=d.panel.find("form.file_download_form");f.find('input[name="fileUrl"]').attr("value",$(this).closest("tr").attr("data-fileUrl"));f.find('input[name="remove_cache"]').attr("value",(new Date()).getTime());f.submit().before(f.clone(true).val("")).remove()});d.panel.on("click","i.icon-move",function(){var h=$("<div></div>"),i=$(this),j=i.closest("tr").find("a.a_folder").attr("data-isfolder")?"文件夹":"文件",g=j+i.closest("tr").find("input.input_file_name").val(),f=$(this).closest("tr").attr("data-fileId");if($(this).hasClass("icon-pencil")){}h.load(context+"/filelibrary/openfilemoveview.htm",{fromFileName:g},function(){var k=-1;k=$.layer({type:1,title:false,area:["auto","500px"],border:[0],shade:[0.8,"#000"],closeBtn:[0,false],shift:["top",500,true],offset:["50px",""],page:{html:h.html()},success:function(l){$(l).on("click",function(m){return false});$(l).on("click","i.icon-cancel-circled",function(){layer.close(k)});b.init(l,f,d.projectId,d.panel.find("span.route").attr("data-currentfileid"),function(m){$.each(d.fileData,function(n,o){if(n.indexOf(d.fileData.propertyTemp)>-1){d.fileData[n]=null}});d.getFileChidren(m)})}})});return false});d.panel.on("click","i.icon-trash-empty",function(){var f=$(this).closest("tr").attr("data-fileId");layer.confirm("确定删除当前文件或文件夹及其下面的所有文件吗",function(g){layer.close(g);$.ajax({url:context+"/filelibrary/deletefilelibrary.htm",type:"post",data:{projectId:d.projectId,folderId:f}}).done(function(j){if(j&&j.success){var i=d.fileData.propertyTemp,h=d.panel.find("span.route").attr("data-currentfileid");d.fileData[i+h]=null;d.getFileChidren(h)}else{if(j&&!j.success&&j.errormsg){layer.alert(j.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)})},function(g){layer.close(g)});return false})},viewInit:function(){this.getFileChidren(0)},refreshFileLibraryView:function(m){var k=this;if(!m){return}var j=k.panel.find("span.route"),l=m.parent,h="";j.attr("data-currentfileid",m.attachment.id);for(var d=l.length-1;d>=0;d--){var g=l[d];h+='<a href="#" data-fileId="'+g.attachment.id+'">'+g.attachment.fileName+'</a> <i class="icon-right-open-big"></i>'}j.empty().append(h);var e=k.panel.find("tbody.tbody_file_manage"),c=m.children,f="";e.closest("div").find("div.none-content").remove();if(c.length>0){$.each(c,function(p,q){var o=window.projectUserList[q.attachment.createdBy],i=q.attachment.folder?"icon-folder-2":"icon-doc-text-1";var n=q.attachment.folder?"":(PRJ_ACCESS?'<i class=" icon-download" title="下载"></i>':"");var r=PRJ_OPERAT&&window.readOnly?'<i class="icon-edit" title="修改名称"></i><i class="icon-move" title="移动"></i><i class="icon-trash-empty" title="删除"></i>':"";f+='<tr data-fileId="'+q.attachment.id+'" data-fileUrl="'+q.attachment.fileUrl+'">';f+='<td><a class="a_folder" data-isfolder="'+q.attachment.folder+'"><i class="'+i+'"></i><input readonly="readonly" title="'+q.attachment.fileName+'" value="'+q.attachment.fileName+'" class="transparency input_file_name"/></a></td>';f+="<td>"+(o&&o.name)||"</td>";f+="<td>"+new Date(q.attachment.updatedTime).format("yyyy-MM-dd")+"</td>";f+="<td>"+n+r+"</td>";f+="</tr>"});e.empty().append(f)}else{e.empty();if(e.closest("div").find("div.none-content").length<=0){e.closest("div").append('<div class="none-content"><i class="icon-folder"></i><br /><a>还没上传文件</a></div>')}}},getFileChidren:function(e){var f=this,d=f.fileData.propertyTemp,c=null;if(f.fileData[d+e]){c=f.fileData[d+e];f.refreshFileLibraryView(c);return}$.ajax({type:"post",url:context+"/filelibrary/listFiles.htm",data:{projectId:f.projectId,fileId:e}}).done(function(g){if(g&&g.success){var h=g.resultData;f.fileData[f.fileData.propertyTemp+h.attachment.id]=h;f.refreshFileLibraryView(h);return}else{if(g&&!g.success&&g.errormsg){layer.alert(g.errormsg,1)}else{layer.alert("请求失败",1)}}}).fail(function(){layer.alert("请求失败",1)})}};a.init()});